<div class="lead-detail-container">
  <!-- Header -->
  <div class="detail-header">
    <button class="back-btn" (click)="goBack()">
      <span class="material-icons">arrow_back</span>
      Back to Pipeline
    </button>
  </div>

  <!-- Loading -->
  @if (isLoading) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Loading lead...</p>
    </div>
  }

  <!-- Error -->
  @if (error) {
    <div class="error-container">
      <span class="material-icons">error_outline</span>
      <p>{{ error }}</p>
      <button class="retry-btn" (click)="loadLead()">Retry</button>
    </div>
  }

  <!-- Content -->
  @if (!isLoading && !error && lead) {
    <div class="detail-content">
      <!-- Left Panel: Lead Info -->
      <div class="info-panel">

        <!-- Suggested Action Banner -->
        @if (lead.computed_suggested_action) {
          <div class="suggested-action-banner" [class]="getSuggestedActionBannerClass(lead.computed_suggested_action.priority)">
            <div class="suggested-action-top">
              <span class="material-icons suggested-icon">{{ lead.computed_suggested_action.icon }}</span>
              <div class="suggested-text">
                <span class="suggested-action-label">Suggested Action</span>
                <span class="suggested-action-value">{{ lead.computed_suggested_action.action }}</span>
              </div>
              <span class="suggested-priority-chip" [class]="'chip-' + lead.computed_suggested_action.priority">
                {{ lead.computed_suggested_action.priority | titlecase }}
              </span>
            </div>
            <p class="suggested-reason">{{ lead.computed_suggested_action.reason }}</p>

            <!-- Priority Score Bar -->
            <div class="priority-score-row">
              <span class="priority-score-label">Priority Score</span>
              <div class="priority-score-track">
                <div
                  class="priority-score-fill"
                  [style.width.%]="priorityScorePercent"
                  [style.background-color]="priorityColor"
                ></div>
              </div>
              <span class="priority-score-value" [style.color]="priorityColor">{{ lead.priority_score }}</span>
            </div>
          </div>
        }

        <!-- Profile Card -->
        <div class="profile-card">
          <div class="avatar-large">
            @if (lead.user.avatar_url) {
              <img [src]="lead.user.avatar_url" [alt]="lead.user.first_name" />
            } @else {
              <div class="avatar-initials">
                {{ lead.user.first_name.charAt(0) }}{{ lead.user.last_name.charAt(0) }}
              </div>
            }
          </div>

          <h2 class="lead-name">{{ lead.user.first_name }} {{ lead.user.last_name }}</h2>

          <div class="contact-info">
            @if (lead.user.phone) {
              <a href="tel:{{ lead.user.phone }}" class="contact-item">
                <span class="material-icons">phone</span>
                {{ formatPhone(lead.user.phone) }}
              </a>
            }
            @if (lead.user.email) {
              <a href="mailto:{{ lead.user.email }}" class="contact-item">
                <span class="material-icons">email</span>
                {{ lead.user.email }}
              </a>
            }
          </div>

          <!-- Stage Badge -->
          <div class="stage-section">
            <div class="stage-badge" [style.background-color]="stageConfig?.bgColor" [style.color]="stageConfig?.color">
              <span class="stage-dot" [style.background-color]="stageConfig?.color"></span>
              {{ stageConfig?.label }}
              <button class="change-stage-btn" (click)="toggleStageMenu()">
                <span class="material-icons">expand_more</span>
              </button>
            </div>

            @if (showStageMenu) {
              <div class="stage-menu">
                @for (stage of stages; track stage.stage) {
                  <button
                    class="stage-option"
                    [class.current]="stage.stage === lead.pipeline_stage"
                    (click)="changeStage(stage.stage)"
                  >
                    <span class="stage-dot" [style.background-color]="stage.color"></span>
                    {{ stage.label }}
                  </button>
                }
              </div>
            }

            <p class="days-in-stage">{{ lead.days_in_stage }} days in stage</p>
          </div>

          <!-- Quick Actions -->
          <div class="quick-actions">
            <button class="action-btn primary" (click)="openSmsModal()">
              <span class="material-icons">sms</span>
              Send SMS
            </button>
            <button class="action-btn" (click)="makeCall()" [disabled]="!lead.user.phone">
              <span class="material-icons">phone</span>
              Call
            </button>
            <button class="action-btn" (click)="viewClientProfile()">
              <span class="material-icons">person</span>
              Profile
            </button>
          </div>
        </div>

        <!-- Completion Status -->
        <div class="section-card">
          <h3>Profile Completion</h3>
          <div class="completion-bar">
            <div class="completion-fill" [style.width.%]="(completionCount / 5) * 100"></div>
          </div>
          <div class="completion-items">
            <div class="completion-item" [class.done]="lead.completion_status.profile_complete">
              <span class="material-icons">{{ lead.completion_status.profile_complete ? 'check_circle' : 'radio_button_unchecked' }}</span>
              Profile Info
            </div>
            <div class="completion-item" [class.done]="lead.completion_status.has_pet">
              <span class="material-icons">{{ lead.completion_status.has_pet ? 'check_circle' : 'radio_button_unchecked' }}</span>
              Pet Added
            </div>
            <div class="completion-item" [class.done]="lead.completion_status.has_address">
              <span class="material-icons">{{ lead.completion_status.has_address ? 'check_circle' : 'radio_button_unchecked' }}</span>
              Address
            </div>
            <div class="completion-item" [class.done]="lead.completion_status.has_payment_method">
              <span class="material-icons">{{ lead.completion_status.has_payment_method ? 'check_circle' : 'radio_button_unchecked' }}</span>
              Payment Method
            </div>
            <div class="completion-item" [class.done]="lead.completion_status.has_started_booking">
              <span class="material-icons">{{ lead.completion_status.has_started_booking ? 'check_circle' : 'radio_button_unchecked' }}</span>
              Started Booking
            </div>
          </div>
        </div>

        <!-- Pets -->
        @if (lead.pets.length > 0) {
          <div class="section-card">
            <h3>Pets</h3>
            <div class="pets-list">
              @for (pet of lead.pets; track pet.id) {
                <div class="pet-item">
                  <span class="material-icons">pets</span>
                  <div class="pet-info">
                    <span class="pet-name">{{ pet.name }}</span>
                    <span class="pet-details">{{ pet.breed || 'Unknown breed' }} &bull; {{ pet.size_category || 'Unknown size' }}</span>
                  </div>
                </div>
              }
            </div>
          </div>
        }

        <!-- Activity Timeline -->
        <div class="section-card">
          <div class="section-header">
            <h3>Activity</h3>
            <div class="activity-header-actions">
              <button class="icon-action-btn" (click)="openLogNoteForm()" title="Add note">
                <span class="material-icons">note_add</span>
                Add Note
              </button>
              <button class="icon-action-btn" (click)="openLogCallForm()" title="Log call">
                <span class="material-icons">phone_callback</span>
                Log Call
              </button>
            </div>
          </div>

          <!-- Log Call Inline Form -->
          @if (showLogCallForm) {
            <div class="inline-form">
              <div class="inline-form-field">
                <label>Outcome</label>
                <select [(ngModel)]="callOutcome">
                  <option value="ANSWERED">Answered</option>
                  <option value="NO_ANSWER">No Answer</option>
                  <option value="LEFT_VM">Left Voicemail</option>
                </select>
              </div>
              <div class="inline-form-field">
                <label>Notes <span class="optional">(optional)</span></label>
                <textarea
                  [(ngModel)]="callNotes"
                  placeholder="What happened on the call?"
                  rows="3"
                ></textarea>
              </div>
              <div class="inline-form-actions">
                <button class="cancel-btn" (click)="cancelLogCall()">Cancel</button>
                <button class="save-btn" (click)="saveCall()" [disabled]="isSavingCall">
                  {{ isSavingCall ? 'Saving...' : 'Save Call' }}
                </button>
              </div>
            </div>
          }

          <!-- Log Note Inline Form -->
          @if (showLogNoteForm) {
            <div class="inline-form">
              <div class="inline-form-field">
                <label>Note</label>
                <textarea
                  [(ngModel)]="noteText"
                  placeholder="Write a note about this lead..."
                  rows="3"
                ></textarea>
              </div>
              <div class="inline-form-actions">
                <button class="cancel-btn" (click)="cancelLogNote()">Cancel</button>
                <button class="save-btn" (click)="saveNote()" [disabled]="isSavingNote || !noteText.trim()">
                  {{ isSavingNote ? 'Saving...' : 'Save Note' }}
                </button>
              </div>
            </div>
          }

          <!-- Timeline Items -->
          @if (isLoadingActivities) {
            <div class="activities-loading">
              <div class="spinner-sm"></div>
            </div>
          } @else if (activities.length === 0) {
            <p class="no-activities">No activity recorded yet</p>
          } @else {
            <div class="timeline">
              @for (activity of activities; track activity.id) {
                <div class="timeline-item">
                  <div class="timeline-icon">
                    <span class="material-icons">{{ getActivityIcon(activity.activity_type) }}</span>
                  </div>
                  <div class="timeline-body">
                    <div class="timeline-top">
                      <span class="timeline-title">{{ getActivityDescription(activity.activity_type) }}</span>
                      @if (activity.outcome && getOutcomeBadge(activity.outcome)) {
                        <span class="outcome-badge" [class]="getOutcomeBadge(activity.outcome)!.cssClass">
                          {{ getOutcomeBadge(activity.outcome)!.label }}
                        </span>
                      }
                    </div>
                    @if (activity.notes) {
                      <p class="timeline-notes">{{ activity.notes }}</p>
                    }
                    <span class="timeline-time">{{ formatRelativeTime(activity.created_at) }}</span>
                  </div>
                </div>
              }
            </div>
          }
        </div>

        <!-- Sticky Notes -->
        <div class="section-card">
          <div class="section-header">
            <h3>Notes</h3>
            @if (!isEditingNotes) {
              <button class="edit-btn" (click)="startEditNotes()">
                <span class="material-icons">edit</span>
              </button>
            }
          </div>
          @if (isEditingNotes) {
            <textarea
              [(ngModel)]="notesInput"
              placeholder="Add notes about this lead..."
              rows="4"
            ></textarea>
            <div class="notes-actions">
              <button class="cancel-btn" (click)="cancelEditNotes()">Cancel</button>
              <button class="save-btn" (click)="saveNotes()" [disabled]="isSavingNotes">
                {{ isSavingNotes ? 'Saving...' : 'Save' }}
              </button>
            </div>
          } @else {
            <p class="notes-text">{{ lead.notes || 'No notes yet' }}</p>
          }
        </div>
      </div>

      <!-- Right Panel: Conversation -->
      <div class="conversation-panel">
        <div class="conversation-header">
          <h3>Conversation</h3>
          @if (conversation) {
            <span class="conversation-status" [class]="'status-' + conversation.status">
              {{ conversation.status }}
            </span>
          }
        </div>

        @if (!conversation) {
          <div class="no-conversation">
            <span class="material-icons">chat_bubble_outline</span>
            <p>No conversation yet</p>
            <button class="start-convo-btn" (click)="openSmsModal()">
              Send First Message
            </button>
          </div>
        } @else {
          <!-- Messages -->
          <div class="messages-container" #messagesContainer>
            @for (message of messages; track message.id; let i = $index) {
              @if (shouldShowDateDivider(message, i)) {
                <div class="date-divider">
                  <span>{{ formatMessageDate(message.created_at) }}</span>
                </div>
              }
              <div class="message" [class]="getMessageClass(message)">
                <div class="message-content">
                  {{ message.content }}
                </div>
                <div class="message-meta">
                  <span class="message-time">{{ formatTime(message.created_at) }}</span>
                  @if (message.ai_intent && getIntentBadge(message.ai_intent)) {
                    <span
                      class="intent-badge"
                      [style.background-color]="getIntentBadge(message.ai_intent)?.color"
                    >
                      {{ getIntentBadge(message.ai_intent)?.label }}
                    </span>
                  }
                </div>
              </div>
            }
          </div>

          <!-- Reply Input -->
          <div class="reply-input">
            <textarea
              [(ngModel)]="replyMessage"
              placeholder="Type a message..."
              rows="2"
              (keydown)="onKeydown($event)"
            ></textarea>
            <button
              class="send-reply-btn"
              (click)="sendReply()"
              [disabled]="!replyMessage.trim() || isSendingReply"
            >
              @if (isSendingReply) {
                <div class="btn-spinner"></div>
              } @else {
                <span class="material-icons">send</span>
              }
            </button>
          </div>
        }
      </div>
    </div>
  }
</div>

<!-- SMS Modal -->
@if (showSmsModal && lead) {
  <app-compose-sms
    [lead]="lead"
    (close)="closeSmsModal()"
    (sent)="onSmsSent()"
  />
}

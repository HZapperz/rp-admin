<div class="lead-card" [class.expanded]="isExpanded" [class.has-unread]="hasUnreadMessages">
  <!-- Compact View (always visible) -->
  <div class="compact-row" (click)="toggleExpand($event)">
    <!-- Avatar -->
    <div class="avatar-sm" [style.background-color]="stageColor">
      {{ initials }}
    </div>

    <!-- Name & Quick Info -->
    <div class="lead-info">
      <div class="name-row">
        <span class="lead-name">{{ lead.user.first_name }} {{ lead.user.last_name }}</span>

        <!-- Geo Boost indicator -->
        @if (lead.geo_boost) {
          <span class="material-icons geo-boost-icon" title="Geo boost active">location_on</span>
        }

        <!-- Priority Score Badge -->
        <span
          class="priority-badge"
          [style.background-color]="priorityBadgeColor"
          [title]="'Priority score: ' + lead.priority_score"
        >{{ lead.priority_score }}</span>
      </div>

      <!-- Suggested action hint (compact view) -->
      @if (suggestedActionText) {
        <span class="suggested-action-hint" [title]="lead.computed_suggested_action?.reason || ''">
          {{ suggestedActionText }}
        </span>
      }

      <span class="lead-meta">
        @if (lead.pets.length > 0) {
          {{ lead.pets.length }} {{ lead.pets.length === 1 ? 'pet' : 'pets' }}
        } @else {
          No pets
        }
        <span class="divider">|</span>
        {{ lead.days_in_stage }}d
      </span>
    </div>

    <!-- Status indicators -->
    <div class="status-icons">
      @if (hasUnreadMessages) {
        <span class="unread-dot" title="Unread messages"></span>
      }
      @if (completionCount === 5) {
        <span class="material-icons complete-icon" title="Profile complete">verified</span>
      }
    </div>

    <!-- Expand toggle -->
    <span class="material-icons expand-icon">{{ isExpanded ? 'expand_less' : 'expand_more' }}</span>
  </div>

  <!-- Expanded Details -->
  @if (isExpanded) {
    <div class="expanded-content">
      <!-- Contact -->
      <div class="detail-row">
        <span class="material-icons">phone</span>
        <span>{{ formattedPhone || 'No phone' }}</span>
      </div>

      @if (lead.user.email) {
        <div class="detail-row">
          <span class="material-icons">email</span>
          <span class="email-text">{{ lead.user.email }}</span>
        </div>
      }

      <!-- Pets -->
      @if (lead.pets.length > 0) {
        <div class="detail-row">
          <span class="material-icons">pets</span>
          <span>{{ petNames }}</span>
        </div>
      }

      <!-- Completion -->
      <div class="completion-row">
        <div class="completion-dots">
          @for (step of getCompletionSteps(); track step.label) {
            <span
              class="completion-dot"
              [class.done]="step.done"
              [title]="step.label"
            ></span>
          }
        </div>
        <span class="completion-text">{{ completionCount }}/5</span>
      </div>

      <!-- Actions -->
      <div class="card-actions">
        <button class="action-btn" (click)="onSendSms($event)" title="Send SMS">
          <span class="material-icons">sms</span>
        </button>
        <button class="action-btn" (click)="onMakeCall($event)" [disabled]="!lead.user.phone" title="Call">
          <span class="material-icons">phone</span>
        </button>
        <button class="action-btn" (click)="onViewDetail($event)" title="View details">
          <span class="material-icons">open_in_new</span>
        </button>
        <div class="move-menu-container">
          <button class="action-btn" (click)="toggleMoveMenu($event)" title="Move">
            <span class="material-icons">drive_file_move</span>
          </button>
          @if (showMoveMenu) {
            <div class="move-menu" (mouseleave)="closeMoveMenu()">
              <!-- Active stages -->
              @for (stage of stages; track stage.stage) {
                <button
                  class="move-option"
                  [class.current]="stage.stage === lead.pipeline_stage"
                  (click)="onMoveToStage(stage.stage, $event)"
                >
                  <span class="stage-dot" [style.background-color]="stage.color"></span>
                  {{ stage.label }}
                </button>
              }

              <!-- End / terminal stages: Converted, Lost, Dormant -->
              <hr class="menu-divider" />
              @for (stage of endStages; track stage.stage) {
                <button
                  class="move-option"
                  [class.current]="stage.stage === lead.pipeline_stage"
                  (click)="onMoveToStage(stage.stage, $event)"
                >
                  <span class="stage-dot" [style.background-color]="stage.color"></span>
                  {{ stage.label }}
                </button>
              }
            </div>
          }
        </div>
      </div>
    </div>
  }
</div>

<div class="promotions-page">
  <div class="page-header">
    <div class="header-content">
      <div>
        <h1>üéÅ Promotions Management</h1>
        <p class="subtitle">Create and manage promotional discounts for customers</p>
      </div>
    </div>
  </div>

  @if (isLoading) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading promotions...</p>
    </div>
  }

  @if (error) {
    <div class="error-message">{{ error }}</div>
  }

  @if (!isLoading && !error) {
    <!-- First-Time Customer Promotion Section -->
    @if (firstTimePromotion) {
      <app-first-time-promotion-card
        [promotion]="firstTimePromotion"
        (updated)="onFirstTimePromotionUpdated()"
      ></app-first-time-promotion-card>
    }

    <!-- General Promotions Section -->
    <div class="general-promotions-section">
      <div class="section-header">
        <h2>üìÖ Other Promotions</h2>
        <button class="btn-create" (click)="openCreateDialog()">+ Add Promotion</button>
      </div>

      <!-- Filters -->
      <div class="filters">
        <div class="filter-group">
          <label for="status">Status:</label>
          <select id="status" (change)="onStatusFilterChange($event)" [value]="selectedStatus">
            <option value="all">All Statuses</option>
            <option value="active">Active</option>
            <option value="scheduled">Scheduled</option>
            <option value="inactive">Inactive</option>
            <option value="expired">Expired</option>
            <option value="maxed_out">Max Reached</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="search">Search:</label>
          <input
            type="text"
            id="search"
            placeholder="Search by title or description..."
            (input)="onSearchChange($event)"
            [value]="searchTerm"
          />
        </div>
      </div>

      <div class="promotions-stats">
        <span>Showing {{ filteredPromotions.length }} of {{ generalPromotions.length }} promotions</span>
      </div>

    <!-- Desktop Table View -->
    <div class="promotions-table-container desktop-view">
      <table class="promotions-table">
        <thead>
          <tr>
            <th>Title</th>
            <th>Discount</th>
            <th>Valid Period</th>
            <th>Usage</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @if (filteredPromotions.length === 0) {
            <tr>
              <td colspan="6" class="no-promotions">
                @if (generalPromotions.length === 0) {
                  <div class="empty-state">
                    <p>No general promotions created yet.</p>
                    <button class="btn-create-small" (click)="openCreateDialog()">Create First Promotion</button>
                  </div>
                } @else {
                  No promotions match your filters
                }
              </td>
            </tr>
          }
          @for (promotion of filteredPromotions; track promotion.id) {
            <tr class="promotion-row" (click)="openEditDialog(promotion)">
              <td>
                <div class="promotion-info">
                  <div class="promotion-title">{{ promotion.title }}</div>
                  @if (promotion.description) {
                    <div class="promotion-description">{{ promotion.description }}</div>
                  }
                </div>
              </td>
              <td>
                <span class="discount-badge">{{ promotion.discount_percentage }}% OFF</span>
              </td>
              <td>
                <div class="date-range">
                  <div>{{ formatDate(promotion.valid_from) }}</div>
                  <div class="to-text">to</div>
                  <div>{{ formatDate(promotion.valid_until) }}</div>
                  @if (getPromotionStatus(promotion) === 'active') {
                    <div class="days-remaining">{{ getDaysRemaining(promotion.valid_until) }} days left</div>
                  }
                </div>
              </td>
              <td>
                <div class="usage-info">
                  <div class="usage-label">{{ getUsageLabel(promotion) }}</div>
                  @if (promotion.max_uses) {
                    <div class="usage-bar">
                      <div class="usage-fill" [style.width.%]="getUsagePercentage(promotion)"></div>
                    </div>
                  }
                </div>
              </td>
              <td>
                <span class="status-badge" [ngClass]="getStatusClass(getPromotionStatus(promotion))">
                  {{ getStatusLabel(getPromotionStatus(promotion)) }}
                </span>
              </td>
              <td class="actions">
                <div class="action-buttons">
                  <button
                    class="btn-toggle"
                    [class.active]="promotion.is_active"
                    (click)="togglePromotionStatus(promotion, $event)"
                    title="{{ promotion.is_active ? 'Deactivate' : 'Activate' }}">
                    {{ promotion.is_active ? '‚è∏' : '‚ñ∂' }}
                  </button>
                  <button
                    class="btn-edit"
                    (click)="openEditDialog(promotion); $event.stopPropagation()"
                    title="Edit">
                    ‚úèÔ∏è
                  </button>
                  <button
                    class="btn-delete"
                    (click)="deletePromotion(promotion, $event)"
                    title="Delete">
                    üóëÔ∏è
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Mobile Card View -->
    <div class="promotions-cards-container mobile-view">
      @if (filteredPromotions.length === 0) {
        <div class="empty-state-mobile">
          @if (generalPromotions.length === 0) {
            <p>No general promotions created yet.</p>
            <button class="btn-create-small" (click)="openCreateDialog()">Create First Promotion</button>
          } @else {
            <p>No promotions match your filters</p>
          }
        </div>
      }

      @for (promotion of filteredPromotions; track promotion.id) {
        <div class="promotion-card" (click)="openEditDialog(promotion)">
          <div class="promotion-card-header">
            <span class="discount-badge">{{ promotion.discount_percentage }}% OFF</span>
            <span class="status-badge" [ngClass]="getStatusClass(getPromotionStatus(promotion))">
              {{ getStatusLabel(getPromotionStatus(promotion)) }}
            </span>
          </div>

          <div class="promotion-card-body">
            <h3 class="promotion-title">{{ promotion.title }}</h3>
            @if (promotion.description) {
              <p class="promotion-description">{{ promotion.description }}</p>
            }

            <div class="promotion-card-details">
              <div class="detail-row">
                <span class="label">Valid:</span>
                <span class="value">{{ formatDate(promotion.valid_from) }} - {{ formatDate(promotion.valid_until) }}</span>
              </div>
              @if (getPromotionStatus(promotion) === 'active') {
                <div class="detail-row">
                  <span class="label">Remaining:</span>
                  <span class="value highlight">{{ getDaysRemaining(promotion.valid_until) }} days left</span>
                </div>
              }
              <div class="detail-row">
                <span class="label">Usage:</span>
                <span class="value">{{ getUsageLabel(promotion) }}</span>
              </div>
            </div>

            @if (promotion.max_uses) {
              <div class="usage-bar-mobile">
                <div class="usage-fill" [style.width.%]="getUsagePercentage(promotion)"></div>
              </div>
            }
          </div>

          <div class="promotion-card-footer">
            <button
              class="btn-action btn-toggle-mobile"
              [class.active]="promotion.is_active"
              (click)="togglePromotionStatus(promotion, $event)">
              {{ promotion.is_active ? 'Pause' : 'Activate' }}
            </button>
            <button
              class="btn-action btn-edit-mobile"
              (click)="openEditDialog(promotion); $event.stopPropagation()">
              Edit
            </button>
            <button
              class="btn-action btn-delete-mobile"
              (click)="deletePromotion(promotion, $event)">
              Delete
            </button>
          </div>
        </div>
      }
    </div>
    </div>
  }
</div>

<!-- Promotion Form Dialog -->
@if (showPromotionDialog) {
  <div class="dialog-overlay" (click)="closeDialog()">
    <div class="dialog-content" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>{{ editingPromotion ? 'Edit Promotion' : 'Create Promotion' }}</h2>
        <button class="btn-close" (click)="closeDialog()">√ó</button>
      </div>
      <app-promotion-form-dialog
        [promotion]="editingPromotion"
        (close)="closeDialog()"
        (save)="onPromotionSaved()"
      ></app-promotion-form-dialog>
    </div>
  </div>
}

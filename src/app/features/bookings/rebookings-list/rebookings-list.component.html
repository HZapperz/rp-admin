<div class="rebookings-page">
  <div class="page-header">
    <div class="header-content">
      <div>
        <h1>Follow-up Rebookings</h1>
        <p class="subtitle">Manage follow-up scheduling requests from groomers</p>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters">
    <div class="filter-group">
      <label for="status">Status:</label>
      <select
        id="status"
        (change)="onStatusFilterChange($event)"
        [value]="selectedStatus"
      >
        @for (option of statusOptions; track option.value) {
          <option [value]="option.value">{{ option.label }}</option>
        }
      </select>
    </div>

    <button class="refresh-btn" (click)="loadRebookings()" [disabled]="isLoading">
      <span [class.spinning]="isLoading">&#x21bb;</span>
      Refresh
    </button>
  </div>

  @if (isLoading) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading rebookings...</p>
    </div>
  }

  @if (error) {
    <div class="error-message">{{ error }}</div>
  }

  @if (!isLoading && !error) {
    <!-- Stats Summary -->
    @if (selectedStatus === 'all') {
      <div class="stats-summary">
        <div class="stat-card pending">
          <span class="stat-value">{{ getStats().pending }}</span>
          <span class="stat-label">Pending</span>
        </div>
        <div class="stat-card contacted">
          <span class="stat-value">{{ getStats().contacted }}</span>
          <span class="stat-label">Contacted</span>
        </div>
        <div class="stat-card booked">
          <span class="stat-value">{{ getStats().booked }}</span>
          <span class="stat-label">Booked</span>
        </div>
        <div class="stat-card no-answer">
          <span class="stat-value">{{ getStats().no_answer }}</span>
          <span class="stat-label">No Answer</span>
        </div>
        <div class="stat-card declined">
          <span class="stat-value">{{ getStats().declined }}</span>
          <span class="stat-label">Declined</span>
        </div>
      </div>
    }

    <div class="rebookings-count">
      Showing {{ rebookings.length }} rebooking{{ rebookings.length !== 1 ? 's' : '' }}
    </div>

    @if (rebookings.length === 0) {
      <div class="empty-state">
        <p>No rebookings found</p>
        <span class="empty-hint">
          {{ selectedStatus === 'all' ? 'No rebooking requests have been submitted yet.' : 'No rebookings with "' + getStatusLabel(selectedStatus) + '" status.' }}
        </span>
      </div>
    } @else {
      <!-- Desktop Table View -->
      <div class="rebookings-table-container desktop-view">
        <table class="rebookings-table">
          <thead>
            <tr>
              <th>Type</th>
              <th>Client</th>
              <th>Phone</th>
              <th>Date</th>
              <th>Time</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (rebooking of rebookings; track rebooking.id) {
              <tr class="rebooking-row" [class.expanded]="isExpanded(rebooking.id)" (click)="toggleExpand(rebooking.id, $event)">
                <td>
                  <span class="type-badge" [class.schedule]="rebooking.type === 'schedule'" [class.callback]="rebooking.type === 'callback'">
                    {{ getTypeLabel(rebooking.type) }}
                  </span>
                </td>
                <td>
                  <div class="client-info">
                    <div class="client-name">{{ rebooking.client?.first_name }} {{ rebooking.client?.last_name }}</div>
                    <div class="pet-names">{{ getPetNames(rebooking) }}</div>
                  </div>
                </td>
                <td>
                  <a class="phone-link" href="tel:{{ rebooking.client?.phone }}" (click)="$event.stopPropagation()">
                    {{ formatPhone(rebooking.client?.phone) }}
                  </a>
                </td>
                <td>{{ getRelevantDate(rebooking) }}</td>
                <td class="time-slot">
                  {{ rebooking.type === 'schedule' ? (rebooking.preferred_time_slot || '-') : '-' }}
                </td>
                <td>
                  <span class="status-badge" [ngClass]="getStatusClass(rebooking.status)">
                    {{ getStatusLabel(rebooking.status) }}
                  </span>
                </td>
                <td class="actions-cell">
                  <span class="expand-icon" [class.rotated]="isExpanded(rebooking.id)">&#9662;</span>
                </td>
              </tr>

              @if (isExpanded(rebooking.id)) {
                <tr class="expanded-row">
                  <td colspan="7">
                    <div class="expanded-content">
                      <!-- Groomer Notes -->
                      @if (rebooking.groomer_notes) {
                        <div class="notes-section">
                          <label>Groomer Notes:</label>
                          <p class="groomer-notes">{{ rebooking.groomer_notes }}</p>
                        </div>
                      }

                      <!-- Admin Notes -->
                      <div class="notes-section">
                        <label>Admin Notes:</label>
                        <div class="notes-input-group">
                          <textarea
                            [(ngModel)]="adminNotes[rebooking.id]"
                            placeholder="Add notes about this rebooking..."
                            rows="2"
                            (click)="$event.stopPropagation()"
                          ></textarea>
                          <button
                            class="save-notes-btn"
                            (click)="saveNotes(rebooking.id, $event)"
                            [disabled]="updatingId === rebooking.id"
                          >
                            Save
                          </button>
                        </div>
                      </div>

                      <!-- Status Actions -->
                      <div class="status-actions">
                        <label>Update Status:</label>
                        <div class="action-buttons">
                          <button
                            class="action-btn contacted"
                            [class.current]="rebooking.status === 'contacted'"
                            [disabled]="rebooking.status === 'contacted' || updatingId === rebooking.id"
                            (click)="updateStatus(rebooking.id, 'contacted', $event)"
                          >
                            Contacted
                          </button>
                          <button
                            class="action-btn booked"
                            [class.current]="rebooking.status === 'booked'"
                            [disabled]="rebooking.status === 'booked' || updatingId === rebooking.id"
                            (click)="updateStatus(rebooking.id, 'booked', $event)"
                          >
                            Booked
                          </button>
                          <button
                            class="action-btn no-answer"
                            [class.current]="rebooking.status === 'no_answer'"
                            [disabled]="rebooking.status === 'no_answer' || updatingId === rebooking.id"
                            (click)="updateStatus(rebooking.id, 'no_answer', $event)"
                          >
                            No Answer
                          </button>
                          <button
                            class="action-btn declined"
                            [class.current]="rebooking.status === 'declined'"
                            [disabled]="rebooking.status === 'declined' || updatingId === rebooking.id"
                            (click)="updateStatus(rebooking.id, 'declined', $event)"
                          >
                            Declined
                          </button>
                        </div>
                      </div>

                      <!-- Contact Actions -->
                      <div class="contact-actions">
                        <button class="contact-btn call" (click)="callClient(rebooking.client?.phone, $event)">
                          <span class="icon">&#128222;</span>
                          Call Client
                        </button>
                        @if (rebooking.client?.email) {
                          <button class="contact-btn email" (click)="emailClient(rebooking.client?.email, $event)">
                            <span class="icon">&#9993;</span>
                            Email Client
                          </button>
                        }
                      </div>
                    </div>
                  </td>
                </tr>
              }
            }
          </tbody>
        </table>
      </div>

      <!-- Mobile Card View -->
      <div class="rebookings-cards-container mobile-view">
        @for (rebooking of rebookings; track rebooking.id) {
          <div class="rebooking-card" [class.expanded]="isExpanded(rebooking.id)">
            <div class="card-header" (click)="toggleExpand(rebooking.id, $event)">
              <div class="header-left">
                <span class="type-badge" [class.schedule]="rebooking.type === 'schedule'" [class.callback]="rebooking.type === 'callback'">
                  {{ getTypeLabel(rebooking.type) }}
                </span>
                <span class="status-badge" [ngClass]="getStatusClass(rebooking.status)">
                  {{ getStatusLabel(rebooking.status) }}
                </span>
              </div>
              <span class="expand-icon" [class.rotated]="isExpanded(rebooking.id)">&#9662;</span>
            </div>

            <div class="card-summary">
              <div class="summary-row">
                <span class="label">Client:</span>
                <span class="value">{{ rebooking.client?.first_name }} {{ rebooking.client?.last_name }}</span>
              </div>
              <div class="summary-row">
                <span class="label">Pet(s):</span>
                <span class="value">{{ getPetNames(rebooking) }}</span>
              </div>
              <div class="summary-row">
                <span class="label">Date:</span>
                <span class="value">{{ getRelevantDate(rebooking) }}</span>
              </div>
              @if (rebooking.type === 'schedule' && rebooking.preferred_time_slot) {
                <div class="summary-row">
                  <span class="label">Time:</span>
                  <span class="value time-slot">{{ rebooking.preferred_time_slot }}</span>
                </div>
              }
            </div>

            @if (isExpanded(rebooking.id)) {
              <div class="card-details">
                <div class="summary-row">
                  <span class="label">Phone:</span>
                  <a class="phone-link" href="tel:{{ rebooking.client?.phone }}" (click)="$event.stopPropagation()">
                    {{ formatPhone(rebooking.client?.phone) }}
                  </a>
                </div>

                @if (rebooking.groomer_notes) {
                  <div class="notes-section">
                    <label>Groomer Notes:</label>
                    <p class="groomer-notes">{{ rebooking.groomer_notes }}</p>
                  </div>
                }

                <div class="notes-section">
                  <label>Admin Notes:</label>
                  <textarea
                    [(ngModel)]="adminNotes[rebooking.id]"
                    placeholder="Add notes..."
                    rows="2"
                    (click)="$event.stopPropagation()"
                  ></textarea>
                  <button
                    class="save-notes-btn"
                    (click)="saveNotes(rebooking.id, $event)"
                    [disabled]="updatingId === rebooking.id"
                  >
                    Save Notes
                  </button>
                </div>

                <div class="status-actions">
                  <label>Update Status:</label>
                  <div class="action-buttons">
                    <button
                      class="action-btn contacted"
                      [class.current]="rebooking.status === 'contacted'"
                      [disabled]="rebooking.status === 'contacted' || updatingId === rebooking.id"
                      (click)="updateStatus(rebooking.id, 'contacted', $event)"
                    >
                      Contacted
                    </button>
                    <button
                      class="action-btn booked"
                      [class.current]="rebooking.status === 'booked'"
                      [disabled]="rebooking.status === 'booked' || updatingId === rebooking.id"
                      (click)="updateStatus(rebooking.id, 'booked', $event)"
                    >
                      Booked
                    </button>
                    <button
                      class="action-btn no-answer"
                      [class.current]="rebooking.status === 'no_answer'"
                      [disabled]="rebooking.status === 'no_answer' || updatingId === rebooking.id"
                      (click)="updateStatus(rebooking.id, 'no_answer', $event)"
                    >
                      No Answer
                    </button>
                    <button
                      class="action-btn declined"
                      [class.current]="rebooking.status === 'declined'"
                      [disabled]="rebooking.status === 'declined' || updatingId === rebooking.id"
                      (click)="updateStatus(rebooking.id, 'declined', $event)"
                    >
                      Declined
                    </button>
                  </div>
                </div>

                <div class="contact-actions">
                  <button class="contact-btn call" (click)="callClient(rebooking.client?.phone, $event)">
                    Call
                  </button>
                  @if (rebooking.client?.email) {
                    <button class="contact-btn email" (click)="emailClient(rebooking.client?.email, $event)">
                      Email
                    </button>
                  }
                </div>
              </div>
            }
          </div>
        }
      </div>
    }
  }
</div>

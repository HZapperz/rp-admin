<div class="booking-details-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p class="text-gray-600 mt-4">Loading booking details...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <div class="error-icon">‚ö†Ô∏è</div>
    <p class="text-red-600 text-lg">{{ error }}</p>
    <button (click)="goBack()" class="btn-back mt-4">
      Go Back to Bookings
    </button>
  </div>

  <!-- Booking Details -->
  <div *ngIf="booking && !loading" class="booking-content">
    <!-- Compact Header -->
    <div class="page-header">
      <button (click)="goBack()" class="btn-back-icon">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <div class="header-center">
        <span class="booking-id-label">Booking</span>
        <span class="booking-id-value">#{{ booking.id.substring(0, 8) }}</span>
      </div>
      <span class="status-badge header-status" [ngClass]="getStatusBadgeClass(booking.status)">
        {{ booking.status | titlecase }}
      </span>
      <button (click)="toggleEditMode()" class="btn-edit" [class.active]="editMode">
        {{ editMode ? 'Cancel' : 'Edit' }}
      </button>
    </div>

    <!-- Quick Info Bar -->
    <div class="quick-info-bar">
      <div class="info-chip">
        <span class="chip-icon">üìÖ</span>
        <span class="chip-value">{{ formatDateShort(booking.scheduled_date) }}</span>
        <span class="chip-sub" *ngIf="booking.scheduled_time_start">{{ formatTime(booking.scheduled_time_start) }}</span>
      </div>
      <div class="info-chip" (click)="navigateToClient()" style="cursor: pointer;" title="View client details">
        <span class="chip-icon">üë§</span>
        <span class="chip-value">{{ booking.client?.first_name }} {{ booking.client?.last_name }}</span>
      </div>
      <div class="info-chip">
        <span class="chip-icon">üêï</span>
        <span class="chip-value">{{ booking.pets?.length }} pet{{ (booking.pets?.length || 0) > 1 ? 's' : '' }}</span>
      </div>
      <div class="info-chip highlight">
        <span class="chip-value">${{ booking.total_amount }}</span>
        <span class="chip-sub payment-status" [ngClass]="booking.payment_status === 'captured' ? 'captured' : 'pending'">
          {{ booking.payment_status | titlecase }}
        </span>
      </div>
      <div class="info-chip" *ngIf="booking.groomer">
        <span class="chip-icon">‚úÇÔ∏è</span>
        <span class="chip-value">{{ booking.groomer.first_name }}</span>
      </div>
    </div>

    <!-- Pending Change Request Alert -->
    <div *ngIf="pendingChangeRequest" class="change-request-alert">
      <div class="alert-header">
        <div class="alert-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
        </div>
        <div class="alert-content">
          <h3>Pending Time Change Request</h3>
          <p>Customer has requested to reschedule this booking</p>
        </div>
      </div>

      <div class="change-request-details">
        <div class="time-comparison">
          <div class="time-box current">
            <span class="time-label">Current</span>
            <span class="time-date">{{ formatDate(pendingChangeRequest.original_date) }}</span>
            <span class="time-slot">{{ formatTimeShort(pendingChangeRequest.original_time_start) }} - {{ formatTimeShort(pendingChangeRequest.original_time_end) }}</span>
          </div>
          <div class="arrow">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="5" y1="12" x2="19" y2="12"></line>
              <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
          </div>
          <div class="time-box requested">
            <span class="time-label">Requested</span>
            <span class="time-date">{{ formatDate(pendingChangeRequest.requested_date) }}</span>
            <span class="time-slot">{{ formatTimeShort(pendingChangeRequest.requested_time_start) }} - {{ formatTimeShort(pendingChangeRequest.requested_time_end) }}</span>
          </div>
        </div>

        <div class="reason-box" *ngIf="pendingChangeRequest.reason">
          <span class="reason-label">Reason:</span>
          <p class="reason-text">{{ pendingChangeRequest.reason }}</p>
        </div>
      </div>

      <div class="change-request-actions">
        <button
          class="btn btn-approve"
          (click)="approveChangeRequest()"
          [disabled]="processingChangeRequest">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          {{ processingChangeRequest ? 'Processing...' : 'Approve' }}
        </button>
        <button
          class="btn btn-reject"
          (click)="openChangeRequestRejectModal()"
          [disabled]="processingChangeRequest">
          Reject
        </button>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="main-grid">
      <!-- Left Column: Main Details -->
      <div class="main-column">
        <!-- Row 1: Client & Location + Schedule & Status -->
        <div class="details-grid two-col">
          <!-- Client & Location -->
          <div class="compact-card">
            <div class="compact-header">
              <h3>Client & Location</h3>
            </div>
            <div class="compact-body" *ngIf="booking.client">
              <div class="client-row">
                <div class="avatar-small" *ngIf="!booking.client.avatar_url" (click)="navigateToClient()" style="cursor: pointer;" title="View client details">
                  {{ booking.client.first_name[0] }}{{ booking.client.last_name[0] }}
                </div>
                <img *ngIf="booking.client.avatar_url" [src]="booking.client.avatar_url" alt="Client" class="avatar-img-small" (click)="navigateToClient()" style="cursor: pointer;" title="View client details">
                <div class="client-details">
                  <span class="client-name" (click)="navigateToClient()" style="cursor: pointer;" title="View client details">{{ booking.client.first_name }} {{ booking.client.last_name }}</span>
                  <div class="contact-icons">
                    <a [href]="'mailto:' + booking.client.email" class="contact-link" title="Email">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                      </svg>
                    </a>
                    <a [href]="'tel:' + booking.client.phone" class="contact-link" title="Phone">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                      </svg>
                    </a>
                  </div>
                </div>
              </div>
              <div class="address-compact">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span>{{ booking.address }}, {{ booking.city }}</span>
              </div>
              <div class="notes-inline" *ngIf="booking.notes && !editMode">
                <strong>Note:</strong> {{ booking.notes }}
              </div>
              <textarea
                *ngIf="editMode"
                [(ngModel)]="editingFields.notes"
                class="notes-textarea-compact"
                rows="2"
                placeholder="Booking notes..."></textarea>
            </div>
          </div>

          <!-- Schedule & Status -->
          <div class="compact-card">
            <div class="compact-header">
              <h3>Schedule & Status</h3>
              <span class="status-badge" [ngClass]="getStatusBadgeClass(booking.status)">
                {{ booking.status | titlecase }}
              </span>
            </div>
            <div class="compact-body">
              <!-- Horizontal Timeline -->
              <div class="timeline-horizontal" *ngIf="booking.status !== 'cancelled'">
                <div class="timeline-step" [class.completed]="isTimelineStepCompleted(0)" [class.current]="isTimelineStepCurrent(0)">
                  <div class="step-dot">{{ isTimelineStepCompleted(0) ? '‚úì' : '1' }}</div>
                  <span class="step-label">Pending</span>
                </div>
                <div class="timeline-step" [class.completed]="isTimelineStepCompleted(1)" [class.current]="isTimelineStepCurrent(1)">
                  <div class="step-dot">{{ isTimelineStepCompleted(1) ? '‚úì' : '2' }}</div>
                  <span class="step-label">Confirmed</span>
                </div>
                <div class="timeline-step" [class.completed]="isTimelineStepCompleted(2)" [class.current]="isTimelineStepCurrent(2)">
                  <div class="step-dot">{{ isTimelineStepCompleted(2) ? '‚úì' : '3' }}</div>
                  <span class="step-label">In Progress</span>
                </div>
                <div class="timeline-step" [class.completed]="isTimelineStepCompleted(3)" [class.current]="isTimelineStepCurrent(3)">
                  <div class="step-dot">{{ isTimelineStepCompleted(3) ? '‚úì' : '4' }}</div>
                  <span class="step-label">Complete</span>
                </div>
              </div>

              <!-- Cancelled status -->
              <div *ngIf="booking.status === 'cancelled'" class="cancelled-badge">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                Cancelled {{ booking.cancelled_at ? 'on ' + formatDate(booking.cancelled_at) : '' }}
              </div>

              <!-- Schedule Info -->
              <div class="schedule-info">
                <div class="schedule-row">
                  <span class="schedule-label">Date:</span>
                  <span class="schedule-value">{{ formatDate(booking.scheduled_date) }}</span>
                </div>
                <div class="schedule-row" *ngIf="booking.status === 'pending' && getTimePreferenceLabel(booking)">
                  <span class="schedule-label">Preferred:</span>
                  <span class="schedule-value">{{ getTimePreferenceLabel(booking) }}</span>
                </div>
                <div class="schedule-row" *ngIf="booking.status !== 'pending' && booking.scheduled_time_start">
                  <span class="schedule-label">Time:</span>
                  <span class="schedule-value">{{ formatTime(booking.scheduled_time_start) }} ‚Äì {{ formatTime(booking.scheduled_time_end || '') }}</span>
                </div>
              </div>

              <!-- Status Actions -->
              <div class="status-actions-compact" *ngIf="booking.status !== 'cancelled'">
                <button
                  *ngIf="booking.status === 'pending'"
                  (click)="updateBookingStatus('confirmed')"
                  class="btn-action btn-confirm"
                  [disabled]="isUpdatingStatus">
                  {{ isUpdatingStatus ? '...' : 'Confirm' }}
                </button>
                <button
                  *ngIf="booking.status === 'confirmed'"
                  (click)="updateBookingStatus('in_progress')"
                  class="btn-action btn-start"
                  [disabled]="isUpdatingStatus">
                  {{ isUpdatingStatus ? '...' : 'Start' }}
                </button>
                <button
                  *ngIf="booking.status === 'in_progress'"
                  (click)="updateBookingStatus('completed')"
                  class="btn-action btn-complete"
                  [disabled]="isUpdatingStatus">
                  {{ isUpdatingStatus ? '...' : 'Complete' }}
                </button>
                <button
                  *ngIf="booking.status === 'confirmed'"
                  (click)="openTimeChangeModal()"
                  class="btn-action btn-change-time-small">
                  Change Time
                </button>
                <button
                  *ngIf="canCancelBooking()"
                  (click)="updateBookingStatus('cancelled')"
                  class="btn-action btn-cancel-small"
                  [disabled]="isUpdatingStatus">
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Row 2: Pets & Services -->
        <div class="pets-section">
          <div class="section-header-compact">
            <h3>Pets & Services</h3>
            <span class="pet-count">{{ booking.pets?.length }} pet{{ (booking.pets?.length || 0) > 1 ? 's' : '' }}</span>
          </div>
          <div class="pets-grid">
            <div class="pet-card-compact" *ngFor="let petBooking of booking.pets">
              <!-- Pet Top Row -->
              <div class="pet-top">
                <img
                  *ngIf="petBooking.pet?.photo_url"
                  [src]="getPetPhotoUrl(petBooking.pet?.photo_url)"
                  alt="Pet photo"
                  class="pet-photo-small">
                <div class="pet-placeholder" *ngIf="!petBooking.pet?.photo_url">
                  üêæ
                </div>
                <div class="pet-info-compact">
                  <span class="pet-name">{{ petBooking.pet?.name }}</span>
                  <span class="pet-breed">{{ petBooking.pet?.breed }}</span>
                  <div class="pet-badges-compact">
                    <span class="badge-small" [ngClass]="getSizeBadgeClass(petBooking.service_size)">
                      {{ petBooking.service_size | uppercase }}
                    </span>
                    <span class="badge-small package-badge" [ngClass]="'package-' + petBooking.package_type">
                      {{ getPackageDisplayName(petBooking.package_type) }}
                    </span>
                  </div>
                </div>
                <div class="pet-price-compact">
                  <span class="price-amount">${{ petBooking.total_price }}</span>
                </div>
              </div>

              <!-- Add-ons inline -->
              <div class="addons-inline" *ngIf="petBooking.addons && petBooking.addons.length > 0">
                <span class="addon-tag" *ngFor="let addon of petBooking.addons">
                  {{ addon.addon_name }} +${{ addon.addon_price }}
                </span>
              </div>

              <!-- Action Buttons -->
              <div class="pet-actions" *ngIf="!booking.payment_captured_at && booking.status !== 'cancelled'">
                <button (click)="openServiceChangeModal(petBooking)" class="btn-pet-action">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                  Modify
                </button>
                <button
                  *ngIf="(booking.pets?.length || 0) > 1"
                  (click)="openRemovePetModal(petBooking)"
                  class="btn-pet-action btn-remove">
                  Remove
                </button>
              </div>

              <!-- Expand/Collapse Health Details -->
              <button class="expand-btn" (click)="togglePetExpansion(petBooking.id)">
                {{ isPetExpanded(petBooking.id) ? 'Hide Details ‚ñ≤' : 'Health & Details ‚ñº' }}
              </button>

              <!-- Collapsible Health Details -->
              <div class="pet-health-collapsed" [class.expanded]="isPetExpanded(petBooking.id)">
                <div class="health-grid-compact">
                  <div class="health-item-compact" *ngIf="petBooking.pet?.age">
                    <span class="hl">Age:</span>
                    <span class="hv">{{ petBooking.pet?.age }}</span>
                  </div>
                  <div class="health-item-compact">
                    <span class="hl">Friendly:</span>
                    <span class="hv" [class.positive]="petBooking.pet?.is_friendly" [class.negative]="!petBooking.pet?.is_friendly">
                      {{ petBooking.pet?.is_friendly ? 'Yes' : 'No' }}
                    </span>
                  </div>
                  <div class="health-item-compact">
                    <span class="hl">Allergies:</span>
                    <span class="hv" [class.warning]="petBooking.pet?.has_allergies">
                      {{ petBooking.pet?.has_allergies ? 'Yes' : 'None' }}
                    </span>
                  </div>
                  <div class="health-item-compact">
                    <span class="hl">Skin Issues:</span>
                    <span class="hv" [class.warning]="petBooking.pet?.has_skin_conditions">
                      {{ petBooking.pet?.has_skin_conditions ? 'Yes' : 'None' }}
                    </span>
                  </div>
                  <div class="health-item-compact">
                    <span class="hl">Behavioral:</span>
                    <span class="hv" [class.warning]="petBooking.pet?.has_behavioral_issues">
                      {{ petBooking.pet?.has_behavioral_issues ? 'Yes' : 'None' }}
                    </span>
                  </div>
                  <div class="health-item-compact" *ngIf="petBooking.pet?.blow_dryer_reaction">
                    <span class="hl">Dryer:</span>
                    <span class="hv">{{ petBooking.pet?.blow_dryer_reaction }}</span>
                  </div>
                </div>

                <!-- Detail notes -->
                <div class="health-notes" *ngIf="petBooking.pet?.allergy_details">
                  <strong>Allergies:</strong> {{ petBooking.pet?.allergy_details }}
                </div>
                <div class="health-notes" *ngIf="petBooking.pet?.skin_condition_details">
                  <strong>Skin:</strong> {{ petBooking.pet?.skin_condition_details }}
                </div>
                <div class="health-notes" *ngIf="petBooking.pet?.behavioral_issue_details">
                  <strong>Behavior:</strong> {{ petBooking.pet?.behavioral_issue_details }}
                </div>
                <div class="health-notes" *ngIf="petBooking.pet?.additional_notes || petBooking.pet?.special_notes">
                  <strong>Notes:</strong> {{ petBooking.pet?.additional_notes || petBooking.pet?.special_notes }}
                </div>

                <!-- Rabies Certificate -->
                <button
                  *ngIf="petBooking.pet?.rabies_certificate_url"
                  (click)="viewRabiesCertificate(petBooking.pet?.rabies_certificate_url!)"
                  class="certificate-link-compact">
                  üìÑ View Rabies Certificate
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Row 3: Payment + Groomer -->
        <div class="details-grid two-col">
          <!-- Payment -->
          <div class="compact-card">
            <div class="compact-header">
              <h3>Payment</h3>
              <div style="display:flex;align-items:center;gap:6px;">
                <button class="btn-edit-sm" (click)="openDiscountEdit()" *ngIf="!isEditingDiscount">Edit Discount</button>
                <span class="status-badge payment-badge" [ngClass]="booking.payment_captured_at ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'">
                  {{ booking.payment_captured_at ? 'Captured' : booking.payment_status | titlecase }}
                </span>
              </div>
            </div>
            <div class="compact-body">
              <!-- Price Breakdown Compact -->
              <div class="price-breakdown-compact">
                <div class="price-row-compact">
                  <span>Subtotal</span>
                  <span>${{ booking.original_subtotal }}</span>
                </div>
                <div class="price-row-compact" *ngIf="booking.discount_amount && booking.discount_amount > 0 && !isEditingDiscount">
                  <span class="text-green-600">Discount</span>
                  <span class="text-green-600">-${{ booking.discount_amount }}</span>
                </div>

                <!-- Inline discount editor -->
                <div class="discount-editor" *ngIf="isEditingDiscount">
                  <div class="discount-editor-header">
                    <span>Apply Discount</span>
                    <button class="btn-cancel-xs" (click)="cancelDiscountEdit()">‚úï</button>
                  </div>
                  <div class="discount-type-toggle">
                    <button [class.active]="discountEditType === 'percentage'" (click)="discountEditType = 'percentage'">%</button>
                    <button [class.active]="discountEditType === 'amount'" (click)="discountEditType = 'amount'">$</button>
                  </div>
                  <div class="discount-input-row">
                    <input
                      type="number"
                      [(ngModel)]="discountEditValue"
                      [placeholder]="discountEditType === 'percentage' ? '0' : '0.00'"
                      [min]="0"
                      [max]="discountEditType === 'percentage' ? 100 : (booking.original_subtotal || 0)"
                      step="0.01"
                      class="discount-input-sm"
                    />
                    <span class="discount-suffix">{{ discountEditType === 'percentage' ? '%' : '$' }}</span>
                  </div>
                  <!-- Live preview -->
                  <div class="discount-preview" *ngIf="discountEditValue > 0">
                    <div class="preview-row">
                      <span>Discount</span>
                      <span class="text-green-600">-${{ getDiscountPreview().discountAmount | number:'1.2-2' }}</span>
                    </div>
                    <div class="preview-row">
                      <span>New Tax</span>
                      <span>${{ getDiscountPreview().taxAmount | number:'1.2-2' }}</span>
                    </div>
                    <div class="preview-row preview-total">
                      <span>New Total</span>
                      <span>${{ getDiscountPreview().total | number:'1.2-2' }}</span>
                    </div>
                  </div>
                  <div class="discount-actions">
                    <button class="btn-save-sm" (click)="saveDiscount()">Apply</button>
                    <button class="btn-cancel-sm" (click)="cancelDiscountEdit()">Cancel</button>
                  </div>
                </div>
                <div class="price-row-compact" *ngIf="booking.credits_applied && booking.credits_applied > 0">
                  <span class="text-blue-600">Credits Applied</span>
                  <span class="text-blue-600">-${{ booking.credits_applied }}</span>
                </div>
                <div class="price-row-compact">
                  <span>Tax</span>
                  <span>${{ booking.tax_amount }}</span>
                </div>
                <div class="price-row-compact">
                  <span>Fees</span>
                  <span>${{ (booking.service_fee || 0) + (booking.processing_fee || 0) }}</span>
                </div>
                <div class="price-row-compact total">
                  <span>Total</span>
                  <span>${{ booking.total_amount }}</span>
                </div>
                <div class="price-row-compact" *ngIf="booking.tip_amount && booking.tip_amount > 0">
                  <span>Tip</span>
                  <span class="text-purple-600">${{ booking.tip_amount }}</span>
                </div>
              </div>

              <!-- Success/Error Messages -->
              <div *ngIf="paymentSuccess" class="alert alert-success">{{ paymentSuccess }}</div>
              <div *ngIf="paymentError" class="alert alert-error">{{ paymentError }}</div>

              <!-- Payment Method Info -->
              <div class="payment-method-info" *ngIf="!booking.payment_captured_at">
                <span class="payment-method-label">Method:</span>
                <span class="payment-method-value" *ngIf="booking.payment_method_last4">
                  {{ booking.payment_method_type | titlecase }} ending in {{ booking.payment_method_last4 }}
                </span>
                <span class="payment-method-value" *ngIf="!booking.payment_method_last4 && booking.payment_status === 'card_saved'">
                  Card on File
                </span>
                <span class="payment-method-value cash" *ngIf="!booking.payment_method_last4 && booking.payment_status !== 'card_saved'">
                  Cash on Service
                </span>
              </div>

              <!-- Payment Actions -->
              <div class="payment-actions-compact">
                <button
                  *ngIf="!booking.payment_captured_at && booking.payment_status === 'card_saved' && booking.status === 'completed'"
                  (click)="openCaptureModal()"
                  class="btn-capture-compact"
                  [disabled]="isCapturingPayment">
                  {{ isCapturingPayment ? 'Processing...' : 'Capture Payment' }}
                </button>
                <button
                  *ngIf="!booking.payment_captured_at && booking.status !== 'cancelled'"
                  (click)="openChangePaymentMethod()"
                  class="btn-change-payment">
                  Change Payment Method
                </button>
                <button
                  *ngIf="booking.payment_captured_at && !booking.tip_amount && booking.payment_method_id"
                  (click)="openTipModal()"
                  class="btn-tip-compact">
                  Add Tip
                </button>
                <span *ngIf="booking.payment_captured_at" class="captured-at">
                  Captured {{ booking.payment_captured_at | date:'short' }}
                </span>
              </div>

              <!-- Earnings Breakdown (if captured) -->
              <div *ngIf="earningsBreakdown" class="earnings-compact">
                <div class="earnings-title">Groomer Payout</div>
                <div class="earnings-amount">${{ earningsBreakdown.groomer_amount?.toFixed(2) }}</div>
              </div>
            </div>
          </div>

          <!-- Groomer or Assignment -->
          <div class="compact-card">
            <div class="compact-header">
              <h3>{{ booking.groomer ? 'Groomer' : 'Assignment' }}</h3>
              <span *ngIf="!booking.groomer && booking.status === 'pending'" class="status-badge bg-yellow-100 text-yellow-800">
                Needs Assignment
              </span>
            </div>
            <div class="compact-body">
              <!-- Groomer Info -->
              <div *ngIf="booking.groomer" class="groomer-info-compact">
                <div class="groomer-row">
                  <div class="avatar-small" *ngIf="!booking.groomer.avatar_url">
                    {{ booking.groomer.first_name[0] }}{{ booking.groomer.last_name[0] }}
                  </div>
                  <img *ngIf="booking.groomer.avatar_url" [src]="booking.groomer.avatar_url" alt="Groomer" class="avatar-img-small">
                  <div class="groomer-details">
                    <span class="groomer-name">{{ booking.groomer.first_name }} {{ booking.groomer.last_name }}</span>
                    <div class="contact-icons">
                      <a [href]="'mailto:' + booking.groomer.email" class="contact-link" title="Email">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                      </a>
                      <a [href]="'tel:' + booking.groomer.phone" class="contact-link" title="Phone">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                        </svg>
                      </a>
                    </div>
                  </div>
                </div>
                <!-- Groomer Notes -->
                <div class="groomer-notes" *ngIf="booking.groomer_notes && !editMode">
                  <strong>Notes:</strong> {{ booking.groomer_notes }}
                </div>
                <textarea
                  *ngIf="editMode"
                  [(ngModel)]="editingFields.groomer_notes"
                  class="notes-textarea-compact"
                  rows="2"
                  placeholder="Groomer notes..."></textarea>
              </div>

              <!-- Assignment Button (no groomer) -->
              <div *ngIf="!booking.groomer && booking.status === 'pending'" class="no-groomer">
                <p>This booking needs a groomer assigned.</p>
                <button (click)="showGroomerAssignment()" class="btn-assign-compact">
                  Assign Groomer
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Service Photos (if any) -->
        <div class="compact-card" *ngIf="hasAnyPetPhotos()">
          <div class="compact-header">
            <h3>Service Photos</h3>
          </div>
          <div class="compact-body">
            <div class="photos-grid-compact">
              <div *ngFor="let petBooking of booking.pets" class="pet-photos-inline">
                <div *ngIf="petBooking.before_photo_url || petBooking.after_photo_url" class="photo-pair">
                  <span class="photo-pet-name">{{ petBooking.pet?.name }}</span>
                  <div class="photo-thumbnails">
                    <div *ngIf="petBooking.before_photo_url" class="photo-thumb" (click)="openPhotoGallery(petBooking.before_photo_url!)">
                      <img [src]="petBooking.before_photo_url" alt="Before">
                      <span class="photo-label">Before</span>
                    </div>
                    <div *ngIf="petBooking.after_photo_url" class="photo-thumb" (click)="openPhotoGallery(petBooking.after_photo_url!)">
                      <img [src]="petBooking.after_photo_url" alt="After">
                      <span class="photo-label">After</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Cancellation Info -->
        <div class="compact-card alert-card" *ngIf="booking.cancelled_at">
          <div class="compact-header">
            <h3>Cancellation</h3>
          </div>
          <div class="compact-body">
            <div class="cancellation-info-compact">
              <p><strong>Cancelled:</strong> {{ formatDateTime(booking.cancelled_at) }}</p>
              <p *ngIf="booking.cancellation_reason"><strong>Reason:</strong> {{ booking.cancellation_reason }}</p>
            </div>
          </div>
        </div>

        <!-- Save Changes Button (Edit Mode) -->
        <div *ngIf="editMode" class="edit-actions-compact">
          <button (click)="saveChanges()" class="btn-save">Save Changes</button>
          <button (click)="toggleEditMode()" class="btn-cancel">Cancel</button>
        </div>
      </div>

      <!-- Sidebar Column -->
      <div class="sidebar-column">
        <!-- Admin Notes -->
        <div class="compact-card sidebar-card">
          <div class="compact-header">
            <h3>Admin Notes</h3>
          </div>
          <div class="compact-body">
            <!-- Add Note Form -->
            <div class="add-note-compact">
              <textarea
                [(ngModel)]="newNote"
                placeholder="Add note..."
                class="note-input-compact"
                rows="2"></textarea>
              <div class="note-form-footer-compact">
                <select [(ngModel)]="newNotePriority" class="priority-select-compact">
                  <option value="low">Low</option>
                  <option value="medium">Med</option>
                  <option value="high">High</option>
                  <option value="urgent">Urgent</option>
                </select>
                <button (click)="saveNote()" [disabled]="!newNote.trim() || savingNote" class="btn-add-note-compact">
                  {{ savingNote ? '...' : 'Add' }}
                </button>
              </div>
            </div>

            <!-- Notes List -->
            <div class="notes-list-compact">
              <div *ngFor="let note of adminNotes" class="note-item-compact">
                <div class="note-header-compact">
                  <span class="note-author-compact">{{ note.admin?.first_name }}</span>
                  <span class="note-priority-compact" [ngClass]="getPriorityBadgeClass(note.priority || 'medium')">
                    {{ note.priority }}
                  </span>
                </div>
                <p class="note-content-compact">{{ note.note }}</p>
                <div class="note-footer-compact">
                  <span class="note-date-compact">{{ formatDateTime(note.created_at) }}</span>
                  <button (click)="deleteNote(note.id)" class="btn-delete-note-compact">√ó</button>
                </div>
              </div>
              <p *ngIf="adminNotes.length === 0" class="no-notes-compact">No notes yet</p>
            </div>
          </div>
        </div>

        <!-- Activity Log -->
        <div class="compact-card sidebar-card" *ngIf="modifications.length > 0">
          <div class="compact-header">
            <h3>Activity</h3>
          </div>
          <div class="compact-body">
            <div class="activity-list-compact">
              <div *ngFor="let mod of modifications" class="activity-item-compact">
                <span class="activity-type-compact">{{ mod.modification_type | titlecase }}</span>
                <span class="activity-date-compact">{{ formatDateTime(mod.created_at) }}</span>
                <span *ngIf="mod.modified_by" class="activity-user-compact">
                  by {{ mod.modified_by.first_name }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reject Booking Dialog -->
  <div *ngIf="showRejectDialog" class="reject-dialog-overlay" (click)="closeRejectDialog()">
    <div class="reject-dialog" (click)="$event.stopPropagation()">
      <div class="reject-dialog-header">
        <h3>Reject Booking</h3>
        <button (click)="closeRejectDialog()" class="dialog-close">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="reject-dialog-body">
        <p class="reject-warning">Are you sure you want to reject this booking?</p>
        <label class="form-label">Rejection Reason (required)</label>
        <textarea
          [(ngModel)]="rejectionReason"
          class="rejection-textarea"
          rows="3"
          placeholder="Please provide a reason..."
          required></textarea>
      </div>
      <div class="reject-dialog-footer">
        <button (click)="confirmReject()" [disabled]="!rejectionReason.trim()" class="btn-confirm-reject">
          Confirm Rejection
        </button>
        <button (click)="closeRejectDialog()" class="btn-cancel-dialog">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Photo Gallery Lightbox -->
  <div *ngIf="photoGalleryOpen" class="photo-lightbox" (click)="closePhotoGallery()">
    <div class="lightbox-content" (click)="$event.stopPropagation()">
      <button class="lightbox-close" (click)="closePhotoGallery()">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      <button class="lightbox-prev" (click)="navigatePhoto('prev')">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <img [src]="selectedPhoto" alt="Full size photo" class="lightbox-image">
      <button class="lightbox-next" (click)="navigatePhoto('next')">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Change Request Reject Modal -->
  <div *ngIf="showChangeRequestRejectModal" class="reject-dialog-overlay" (click)="closeChangeRequestRejectModal()">
    <div class="reject-dialog" (click)="$event.stopPropagation()">
      <div class="reject-dialog-header">
        <h3>Reject Time Change</h3>
        <button (click)="closeChangeRequestRejectModal()" class="dialog-close">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="reject-dialog-body">
        <p class="reject-warning">Reject this time change request?</p>
        <label class="form-label">Reason (optional)</label>
        <textarea
          [(ngModel)]="changeRequestRejectReason"
          class="rejection-textarea"
          rows="3"
          placeholder="Provide a reason..."></textarea>
      </div>
      <div class="reject-dialog-footer">
        <button (click)="confirmRejectChangeRequest()" [disabled]="processingChangeRequest" class="btn-confirm-reject">
          {{ processingChangeRequest ? 'Processing...' : 'Confirm Rejection' }}
        </button>
        <button (click)="closeChangeRequestRejectModal()" class="btn-cancel-dialog">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Capture Payment Modal -->
  <div class="modal-overlay" *ngIf="showCaptureModal" (click)="closeCaptureModal()">
    <div class="capture-modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Capture Payment</h3>
        <button class="modal-close" (click)="closeCaptureModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="payment-summary">
          <div class="summary-row">
            <span class="summary-label">Service Amount:</span>
            <span class="summary-value">${{ captureAmount.toFixed(2) }}</span>
          </div>
          <div class="summary-row tip-row">
            <span class="summary-label">Tip (optional):</span>
            <div class="tip-input-wrapper">
              <span class="currency-prefix">$</span>
              <input type="number" [(ngModel)]="captureTipAmount" min="0" step="0.01" placeholder="0.00" class="tip-input">
            </div>
          </div>
          <div class="summary-row total-row">
            <span class="summary-label">Total:</span>
            <span class="summary-value total">${{ (captureAmount + (captureTipAmount || 0)).toFixed(2) }}</span>
          </div>
        </div>
        <div *ngIf="paymentError" class="alert alert-error">{{ paymentError }}</div>
      </div>
      <div class="modal-footer">
        <button (click)="closeCaptureModal()" class="btn btn-secondary">Cancel</button>
        <button (click)="capturePayment()" [disabled]="isCapturingPayment" class="btn btn-capture-confirm">
          {{ isCapturingPayment ? 'Processing...' : 'Capture $' + (captureAmount + (captureTipAmount || 0)).toFixed(2) }}
        </button>
      </div>
    </div>
  </div>

  <!-- Tip Modal -->
  <div class="modal-overlay" *ngIf="showTipModal" (click)="closeTipModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>Add Tip</h3>
      <p>Enter the tip amount to charge.</p>
      <div class="form-group">
        <label>Tip Amount ($)</label>
        <input type="number" [(ngModel)]="tipAmount" min="0" step="0.01" placeholder="0.00" class="form-input">
      </div>
      <div *ngIf="paymentError" class="alert alert-error">{{ paymentError }}</div>
      <div class="modal-actions">
        <button (click)="closeTipModal()" class="btn btn-secondary">Cancel</button>
        <button (click)="processTip()" [disabled]="isProcessingTip || tipAmount <= 0" class="btn btn-primary">
          {{ isProcessingTip ? 'Processing...' : 'Charge Tip' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Time Change Modal -->
  <div *ngIf="showTimeChangeModal" class="time-change-overlay" (click)="closeTimeChangeModal()">
    <div class="time-change-dialog" (click)="$event.stopPropagation()">
      <div class="time-change-dialog-header">
        <h3>Change Booking Time</h3>
        <button (click)="closeTimeChangeModal()" class="dialog-close">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="time-change-dialog-body">
        <div class="current-schedule-box">
          <h4 class="current-schedule-title">Current</h4>
          <p>{{ formatDate(booking?.scheduled_date || '') }}, {{ formatTime(booking?.scheduled_time_start || '') }}</p>
        </div>
        <div class="form-group">
          <label class="form-label">New Date</label>
          <input type="date" [(ngModel)]="newScheduledDate" [min]="minDate" [max]="maxDate" class="form-input">
        </div>
        <div class="form-group" *ngIf="newScheduledDate">
          <label class="form-label">New Time</label>
          <div class="time-slots-grid">
            <button *ngFor="let slot of morningSlots" (click)="selectNewTimeSlot(slot)" [class.selected]="newTimeSlot?.start === slot.start" class="time-slot-btn">
              {{ slot.label }}
            </button>
            <button *ngFor="let slot of afternoonSlots" (click)="selectNewTimeSlot(slot)" [class.selected]="newTimeSlot?.start === slot.start" class="time-slot-btn">
              {{ slot.label }}
            </button>
          </div>

          <!-- Custom time option -->
          <div class="custom-time-toggle">
            <button (click)="toggleCustomTimeSlotForChange()" class="btn-custom-time-toggle">
              {{ useCustomTimeSlotForChange ? 'Use Standard Slots' : 'Use Custom Time' }}
            </button>
          </div>

          <!-- Custom time inputs -->
          <div *ngIf="useCustomTimeSlotForChange" class="custom-time-inputs">
            <div class="custom-time-row">
              <input
                type="text"
                [(ngModel)]="customStartTimeForChange"
                (blur)="onCustomStartTimeForChangeBlur()"
                placeholder="Start (e.g., 9:30 AM)"
                class="time-input-compact">
              <span class="time-separator">to</span>
              <input
                type="text"
                [(ngModel)]="customEndTimeForChange"
                (blur)="onCustomEndTimeForChangeBlur()"
                placeholder="End (e.g., 11:00 AM)"
                class="time-input-compact">
            </div>
            <button (click)="toggleTimeHelpForChange()" class="btn-time-help">{{ showTimeHelpForChange ? 'Hide format help' : 'Time format help' }}</button>
            <div *ngIf="showTimeHelpForChange" class="time-help-text">
              Formats: "9:30 AM", "930am", "1:00 PM", "130pm"
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Reason</label>
          <textarea [(ngModel)]="timeChangeReason" class="reason-textarea" rows="2" placeholder="Reason for change..." required></textarea>
        </div>
      </div>
      <div class="time-change-dialog-footer">
        <button (click)="confirmTimeChange()" [disabled]="!newScheduledDate || (!newTimeSlot && !isCustomTimeForChangeValid()) || !timeChangeReason.trim() || savingTimeChange" class="btn-confirm-change">
          {{ savingTimeChange ? 'Saving...' : 'Save & Notify' }}
        </button>
        <button (click)="closeTimeChangeModal()" class="btn-cancel-dialog">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Service Change Modal -->
  <div *ngIf="showServiceChangeModal" class="service-change-overlay" (click)="closeServiceChangeModal()">
    <div class="service-change-dialog" (click)="$event.stopPropagation()">
      <div class="service-change-dialog-header">
        <h3>Modify {{ selectedPetForServiceChange?.pet?.name }}'s Service</h3>
        <button (click)="closeServiceChangeModal()" class="dialog-close">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="service-change-dialog-body">
        <div class="current-service-box">
          <h4 class="current-service-title">Current</h4>
          <p>{{ getPackageName(selectedPetForServiceChange?.package_type || 'basic') }} - ${{ selectedPetForServiceChange?.total_price }}</p>
        </div>
        <div class="form-group">
          <label class="form-label">Package</label>
          <div class="package-selection-grid">
            <button *ngFor="let pkg of servicePackages" (click)="selectPackage(pkg.id)" [class.selected]="newPackageType === pkg.id" class="package-option-btn">
              <span class="package-icon">{{ pkg.icon }}</span>
              <span class="package-name">{{ getPackageDisplayName(pkg.id) }}</span>
              <span class="package-price">${{ packagePrices[pkg.id][selectedPetForServiceChange?.service_size || 'medium'] }}</span>
            </button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Add-ons</label>
          <div class="addons-selection-grid">
            <div *ngFor="let addon of getFilteredAddons()" (click)="toggleAddon(addon)" [class.selected]="isAddonSelected(addon)" class="addon-option">
              <div class="addon-checkbox">
                <svg *ngIf="isAddonSelected(addon)" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
              </div>
              <span class="addon-name">{{ addon.name }}</span>
              <span class="addon-price">${{ getAddonPriceForSize(addon) }}</span>
            </div>
          </div>
        </div>
        <div class="price-summary-box">
          <div class="summary-row">
            <span>New Pet Total:</span>
            <span>${{ calculateNewPetTotal() }}</span>
          </div>
          <div class="summary-row total-row" [ngClass]="calculatePriceDifference() >= 0 ? 'increase' : 'decrease'">
            <span>Difference:</span>
            <span>{{ calculatePriceDifference() >= 0 ? '+' : '' }}${{ calculatePriceDifference().toFixed(2) }}</span>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Reason</label>
          <textarea [(ngModel)]="serviceChangeReason" class="reason-textarea" rows="2" placeholder="Reason for change..." required></textarea>
        </div>
      </div>
      <div class="service-change-dialog-footer">
        <button (click)="confirmServiceChange()" [disabled]="!serviceChangeReason.trim() || savingServiceChange" class="btn-confirm-change">
          {{ savingServiceChange ? 'Saving...' : 'Save & Notify' }}
        </button>
        <button (click)="closeServiceChangeModal()" class="btn-cancel-dialog">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Remove Pet Modal -->
  <div *ngIf="showRemovePetModal" class="service-change-overlay" (click)="closeRemovePetModal()">
    <div class="service-change-dialog remove-pet-dialog" (click)="$event.stopPropagation()">
      <div class="service-change-dialog-header">
        <h3>Remove {{ petToRemove?.pet?.name }}</h3>
        <button (click)="closeRemovePetModal()" class="dialog-close">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="service-change-dialog-body">
        <div class="remove-pet-warning">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <p>This will remove <strong>{{ petToRemove?.pet?.name }}</strong> from the booking.</p>
        </div>
        <div class="price-summary-box">
          <div class="summary-row">
            <span>Current Total:</span>
            <span>${{ booking?.total_amount }}</span>
          </div>
          <div class="summary-row">
            <span>Removing:</span>
            <span class="text-red-600">-${{ petToRemove?.total_price }}</span>
          </div>
          <div class="summary-row total-row">
            <span>New Total:</span>
            <span>${{ calculateRemovePetNewTotal().toFixed(2) }}</span>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Reason</label>
          <textarea [(ngModel)]="removePetReason" class="reason-textarea" rows="2" placeholder="Reason for removal..." required></textarea>
        </div>
      </div>
      <div class="service-change-dialog-footer">
        <button (click)="confirmRemovePet()" [disabled]="!removePetReason.trim() || isRemovingPet" class="btn-confirm-remove">
          {{ isRemovingPet ? 'Removing...' : 'Remove Pet' }}
        </button>
        <button (click)="closeRemovePetModal()" class="btn-cancel-dialog">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Change Payment Method Modal -->
  <div *ngIf="showChangePaymentModal" class="modal-overlay" (click)="closeChangePaymentModal()">
    <div class="change-payment-dialog" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Change Payment Method</h3>
        <button class="modal-close" (click)="closeChangePaymentModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <!-- Current Payment Method -->
        <div class="current-payment-box">
          <span class="current-payment-label">Current Method</span>
          <div class="current-payment-value" *ngIf="booking?.payment_method_last4">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
              <line x1="1" y1="10" x2="23" y2="10"></line>
            </svg>
            {{ booking?.payment_method_type | titlecase }} ending in {{ booking?.payment_method_last4 }}
          </div>
          <div class="current-payment-value" *ngIf="!booking?.payment_method_last4 && booking?.payment_status === 'card_saved'">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
              <line x1="1" y1="10" x2="23" y2="10"></line>
            </svg>
            Card on File
          </div>
          <div class="current-payment-value cash" *ngIf="!booking?.payment_method_last4 && booking?.payment_status !== 'card_saved'">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="1" x2="12" y2="23"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
            Cash on Service
          </div>
        </div>

        <!-- Loading State -->
        <div *ngIf="isLoadingPaymentMethods" class="payment-methods-loading">
          <div class="spinner-small"></div>
          <span>Loading saved cards...</span>
        </div>

        <!-- Payment Method Options -->
        <div *ngIf="!isLoadingPaymentMethods" class="payment-method-options">
          <label class="payment-options-label">Select New Method</label>

          <!-- Saved Cards -->
          <div
            *ngFor="let method of clientPaymentMethods"
            class="payment-method-tile"
            [class.selected]="selectedNewPaymentMethod?.id === method.id"
            (click)="selectNewPaymentMethod(method)">
            <div class="tile-radio">
              <div class="radio-dot" *ngIf="selectedNewPaymentMethod?.id === method.id"></div>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
              <line x1="1" y1="10" x2="23" y2="10"></line>
            </svg>
            <div class="tile-details">
              <span class="tile-brand">{{ method.brand | titlecase }}</span>
              <span class="tile-last4">**** {{ method.last4 }}</span>
            </div>
            <span class="tile-expiry">{{ method.exp_month }}/{{ method.exp_year }}</span>
            <span *ngIf="method.is_default" class="tile-default-badge">Default</span>
          </div>

          <!-- No cards message -->
          <div *ngIf="clientPaymentMethods.length === 0" class="no-cards-message">
            <p>No saved cards found for this client.</p>
          </div>

          <!-- Cash Option -->
          <div
            class="payment-method-tile cash-tile"
            [class.selected]="changePaymentToCash"
            (click)="selectCashPayment()">
            <div class="tile-radio">
              <div class="radio-dot" *ngIf="changePaymentToCash"></div>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="1" x2="12" y2="23"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
            <div class="tile-details">
              <span class="tile-brand">Cash on Service</span>
              <span class="tile-last4">Pay at appointment</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button (click)="closeChangePaymentModal()" class="btn btn-secondary">Cancel</button>
        <button
          (click)="confirmChangePaymentMethod()"
          [disabled]="isChangingPaymentMethod || (!selectedNewPaymentMethod && !changePaymentToCash)"
          class="btn btn-primary">
          {{ isChangingPaymentMethod ? 'Updating...' : 'Confirm Change' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Groomer Assignment Modal -->
  <div *ngIf="showAssignmentForm" class="assignment-modal-overlay" (click)="hideAssignmentForm()">
    <div class="assignment-modal-dialog" (click)="$event.stopPropagation()">
      <div class="assignment-modal-header">
        <h3>Assign Groomer &amp; Approve Booking</h3>
        <button (click)="hideAssignmentForm()" class="dialog-close">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="assignment-modal-body">
        <!-- Left Column: Form -->
        <div class="assignment-col-main">
          <!-- Step 1: Select Groomer -->
          <div class="form-row">
            <label>1. Groomer</label>
            <select [(ngModel)]="selectedGroomerId" (ngModelChange)="onGroomerChange()" class="form-select-compact">
              <option value="">Select groomer...</option>
              <option *ngFor="let g of availableGroomers" [value]="g.id">{{ g.first_name }} {{ g.last_name }}</option>
            </select>
          </div>

          <!-- Step 2: Select Date -->
          <div class="form-row">
            <label>2. Date</label>
            <input
              type="date"
              [(ngModel)]="selectedDate"
              [min]="minDate"
              [max]="maxDate"
              (change)="onDateChange()"
              class="form-input-compact"
              [disabled]="!selectedGroomerId">
          </div>

          <!-- Step 3: Select Time Slot -->
          <div class="form-row" *ngIf="selectedGroomerId && selectedDate">
            <label>3. Time Slot</label>

            <!-- Client preference info -->
            <div *ngIf="booking?.shift_preference || booking?.time_preferences?.length" class="client-preference-info">
              <span class="preference-label">Client requested:</span>
              <span class="preference-value">{{ getTimePreferenceLabel(booking) }}</span>
            </div>

            <!-- Loading state -->
            <div *ngIf="isLoadingSlots" class="slots-loading">
              <span class="spinner-small"></span> Loading available slots...
            </div>

            <!-- Info banner (groomer has no standard schedule, not an error) -->
            <div *ngIf="!isLoadingSlots && groomerUnavailableReason" class="groomer-info-banner">
              ‚ÑπÔ∏è {{ groomerUnavailableReason }}
            </div>

            <!-- Time slot grid (always shown once date selected, never hard-blocked) -->
            <div *ngIf="!isLoadingSlots" class="time-slots-sections">
              <!-- Morning slots -->
              <div class="slot-section" [class.preferred]="booking!.shift_preference === 'morning'">
                <div class="slot-section-header">
                  <span class="slot-section-title">Morning</span>
                  <span *ngIf="booking!.shift_preference === 'morning'" class="preferred-badge">Preferred</span>
                </div>
                <div class="time-slots-grid">
                  <button
                    *ngFor="let slot of morningSlots"
                    (click)="selectTimeSlot(slot)"
                    [class.selected]="selectedTimeSlot?.start === slot.start"
                    [class.slot-busy]="!isSlotAvailable(slot)"
                    [title]="getSlotConflictReason(slot)"
                    class="slot-btn-granular">
                    {{ slot.label }}
                    <span *ngIf="!isSlotAvailable(slot)" class="slot-busy-badge">Busy</span>
                  </button>
                </div>
              </div>

              <!-- Afternoon slots -->
              <div class="slot-section" [class.preferred]="booking!.shift_preference === 'afternoon'">
                <div class="slot-section-header">
                  <span class="slot-section-title">Afternoon</span>
                  <span *ngIf="booking!.shift_preference === 'afternoon'" class="preferred-badge">Preferred</span>
                </div>
                <div class="time-slots-grid">
                  <button
                    *ngFor="let slot of afternoonSlots"
                    (click)="selectTimeSlot(slot)"
                    [class.selected]="selectedTimeSlot?.start === slot.start"
                    [class.slot-busy]="!isSlotAvailable(slot)"
                    [title]="getSlotConflictReason(slot)"
                    class="slot-btn-granular">
                    {{ slot.label }}
                    <span *ngIf="!isSlotAvailable(slot)" class="slot-busy-badge">Busy</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Custom time toggle -->
            <div class="custom-time-toggle" *ngIf="!isLoadingSlots">
              <button (click)="toggleCustomTimeSlot()" class="btn-custom-time-toggle">
                {{ useCustomTimeSlot ? 'Use Standard Slots' : 'Use Custom Time' }}
              </button>
            </div>

            <!-- Custom time inputs -->
            <div *ngIf="useCustomTimeSlot" class="custom-time-inputs">
              <div class="custom-time-row">
                <input
                  type="text"
                  [(ngModel)]="customStartTime"
                  (blur)="onCustomStartTimeBlur()"
                  placeholder="Start (e.g., 9:30 AM)"
                  class="time-input-compact">
                <span class="time-separator">to</span>
                <input
                  type="text"
                  [(ngModel)]="customEndTime"
                  (blur)="onCustomEndTimeBlur()"
                  placeholder="End (e.g., 11:00 AM)"
                  class="time-input-compact">
              </div>
              <button (click)="toggleTimeHelp()" class="btn-time-help">{{ showTimeHelp ? 'Hide format help' : 'Time format help' }}</button>
              <div *ngIf="showTimeHelp" class="time-help-text">
                Formats: "9:30 AM", "930am", "1:00 PM", "130pm"
              </div>
            </div>
          </div>

          <div class="assignment-actions">
            <button (click)="assignGroomerAndApprove()" [disabled]="!selectedDate || !selectedGroomerId || (!selectedTimeSlot && !isCustomTimeValid()) || assigningGroomer" class="btn-approve-compact">
              {{ assigningGroomer ? 'Approving...' : 'Approve & Assign' }}
            </button>
            <button (click)="openRejectDialog()" class="btn-reject-compact">Reject</button>
            <button (click)="hideAssignmentForm()" class="btn-cancel-compact">Cancel</button>
          </div>
        </div>

        <!-- Right Column: Day Schedule -->
        <div class="assignment-col-schedule" *ngIf="selectedDate && groomerAvailabilityInfo">
          <h4 style="font-size: 0.75rem; font-weight: 600; color: #374151; text-transform: uppercase; letter-spacing: 0.05em; margin: 0 0 0.75rem;">
            Schedule for {{ selectedDate }}
          </h4>
          <div *ngIf="groomerAvailabilityInfo.existing_bookings?.length; else noSchedule">
            <div *ngFor="let b of groomerAvailabilityInfo.existing_bookings" class="schedule-booking-item">
              <span>{{ formatTime(b.start_time) }} ‚Äì {{ formatTime(b.end_time) }}</span>
              <span style="color: #6b7280; font-size: 0.75rem;">Booked</span>
            </div>
          </div>
          <ng-template #noSchedule>
            <p class="schedule-empty">No bookings for this date.</p>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</div>

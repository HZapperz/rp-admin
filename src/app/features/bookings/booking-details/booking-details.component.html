<div class="booking-details-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p class="text-gray-600 mt-4">Loading booking details...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <div class="error-icon">⚠️</div>
    <p class="text-red-600 text-lg">{{ error }}</p>
    <button (click)="goBack()" class="btn-back mt-4">
      Go Back to Bookings
    </button>
  </div>

  <!-- Booking Details -->
  <div *ngIf="booking && !loading" class="booking-content">
    <!-- Header -->
    <div class="page-header">
      <button (click)="goBack()" class="btn-back-icon">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back
      </button>
      <div class="header-title">
        <h1>Booking Details</h1>
        <p class="booking-id">ID: {{ booking.id }}</p>
      </div>
      <button (click)="toggleEditMode()" class="btn-edit" [class.active]="editMode">
        {{ editMode ? 'Cancel' : 'Edit' }}
      </button>
    </div>

    <!-- Pending Change Request Alert -->
    <div *ngIf="pendingChangeRequest" class="change-request-alert">
      <div class="alert-header">
        <div class="alert-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
        </div>
        <div class="alert-content">
          <h3>Pending Time Change Request</h3>
          <p>Customer has requested to reschedule this booking</p>
        </div>
      </div>

      <div class="change-request-details">
        <div class="time-comparison">
          <div class="time-box current">
            <span class="time-label">Current</span>
            <span class="time-date">{{ formatDate(pendingChangeRequest.original_date) }}</span>
            <span class="time-slot">{{ formatTimeShort(pendingChangeRequest.original_time_start) }} - {{ formatTimeShort(pendingChangeRequest.original_time_end) }}</span>
          </div>
          <div class="arrow">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="5" y1="12" x2="19" y2="12"></line>
              <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
          </div>
          <div class="time-box requested">
            <span class="time-label">Requested</span>
            <span class="time-date">{{ formatDate(pendingChangeRequest.requested_date) }}</span>
            <span class="time-slot">{{ formatTimeShort(pendingChangeRequest.requested_time_start) }} - {{ formatTimeShort(pendingChangeRequest.requested_time_end) }}</span>
          </div>
        </div>

        <div class="reason-box">
          <span class="reason-label">Reason:</span>
          <p class="reason-text">{{ pendingChangeRequest.reason }}</p>
        </div>
      </div>

      <div class="change-request-actions">
        <button
          class="btn btn-approve"
          (click)="approveChangeRequest()"
          [disabled]="processingChangeRequest"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          {{ processingChangeRequest ? 'Processing...' : 'Approve Change' }}
        </button>
        <button
          class="btn btn-reject"
          (click)="openChangeRequestRejectModal()"
          [disabled]="processingChangeRequest"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          Reject
        </button>
      </div>
    </div>

    <div class="content-grid">
      <!-- Main Content Column -->
      <div class="main-column">
        <!-- Status & Timeline Section -->
        <div class="card">
          <div class="card-header">
            <h2>Status & Timeline</h2>
            <span class="status-badge" [ngClass]="getStatusBadgeClass(booking.status)">
              {{ booking.status | titlecase }}
            </span>
          </div>

          <!-- Status Actions -->
          <div class="status-actions" *ngIf="booking.status !== 'cancelled'">
            <button
              *ngIf="booking.status === 'pending'"
              (click)="updateBookingStatus('confirmed')"
              class="btn btn-status btn-confirm"
              [disabled]="isUpdatingStatus">
              {{ isUpdatingStatus ? 'Updating...' : 'Confirm Booking' }}
            </button>
            <button
              *ngIf="booking.status === 'confirmed'"
              (click)="updateBookingStatus('in_progress')"
              class="btn btn-status btn-start"
              [disabled]="isUpdatingStatus">
              {{ isUpdatingStatus ? 'Updating...' : 'Start Service' }}
            </button>
            <button
              *ngIf="booking.status === 'in_progress'"
              (click)="updateBookingStatus('completed')"
              class="btn btn-status btn-complete"
              [disabled]="isUpdatingStatus">
              {{ isUpdatingStatus ? 'Updating...' : 'Mark as Completed' }}
            </button>
            <button
              *ngIf="canCancelBooking()"
              (click)="updateBookingStatus('cancelled')"
              class="btn btn-status btn-cancel"
              [disabled]="isUpdatingStatus">
              Cancel Booking
            </button>
          </div>

          <div class="timeline">
            <div *ngFor="let event of timelineEvents" class="timeline-event">
              <div class="timeline-icon" [ngClass]="'timeline-' + event.type">
                {{ event.icon }}
              </div>
              <div class="timeline-content">
                <h4>{{ event.label }}</h4>
                <p>{{ formatDateTime(event.timestamp) }}</p>
              </div>
            </div>
          </div>

          <!-- Scheduled Time Info -->
          <div class="scheduled-info" *ngIf="booking.scheduled_date">
            <div class="info-row">
              <span class="label">Scheduled Date:</span>
              <span class="value">{{ formatDate(booking.scheduled_date) }}</span>
            </div>
            <div class="info-row" *ngIf="booking.shift_preference">
              <span class="label">Shift Preference:</span>
              <span class="value">{{ booking.shift_preference | titlecase }}</span>
            </div>
            <div class="info-row" *ngIf="booking.scheduled_time_start">
              <span class="label">Scheduled Time:</span>
              <span class="value">
                {{ formatTime(booking.scheduled_time_start) }} - {{ formatTime(booking.scheduled_time_end || '') }}
              </span>
            </div>
            <div class="info-row" *ngIf="booking.assigned_time_slot">
              <span class="label">Assigned Slot:</span>
              <span class="value">{{ booking.assigned_time_slot }}</span>
            </div>

            <!-- Change Time Button (only for confirmed bookings) -->
            <button
              *ngIf="booking.status === 'confirmed'"
              (click)="openTimeChangeModal()"
              class="btn-change-time">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Change Date/Time
            </button>
          </div>

          <!-- Actual Service Time -->
          <div class="service-time" *ngIf="booking.actual_start_time || booking.actual_end_time">
            <h3 class="section-subtitle">Actual Service Time</h3>
            <div class="info-row" *ngIf="booking.actual_start_time">
              <span class="label">Started:</span>
              <span class="value">{{ formatDateTime(booking.actual_start_time) }}</span>
            </div>
            <div class="info-row" *ngIf="booking.actual_end_time">
              <span class="label">Ended:</span>
              <span class="value">{{ formatDateTime(booking.actual_end_time) }}</span>
            </div>
            <div class="info-row" *ngIf="booking.actual_start_time && booking.actual_end_time">
              <span class="label">Duration:</span>
              <span class="value">
                {{ calculateDuration(booking.actual_start_time, booking.actual_end_time) }} minutes
              </span>
            </div>
          </div>
        </div>

        <!-- Client Information -->
        <div class="card">
          <div class="card-header">
            <h2>Client Information</h2>
          </div>
          <div class="client-info" *ngIf="booking.client">
            <div class="avatar-section">
              <div class="avatar" *ngIf="!booking.client.avatar_url">
                {{ booking.client.first_name[0] }}{{ booking.client.last_name[0] }}
              </div>
              <img *ngIf="booking.client.avatar_url" [src]="booking.client.avatar_url" alt="Client avatar" class="avatar-img">
              <div>
                <h3>{{ booking.client.first_name }} {{ booking.client.last_name }}</h3>
                <p class="text-sm text-gray-600">Client ID: {{ booking.client.id }}</p>
              </div>
            </div>
            <div class="contact-info">
              <div class="info-row">
                <span class="label">Email:</span>
                <a [href]="'mailto:' + booking.client.email" class="value link">{{ booking.client.email }}</a>
              </div>
              <div class="info-row">
                <span class="label">Phone:</span>
                <a [href]="'tel:' + booking.client.phone" class="value link">{{ booking.client.phone }}</a>
              </div>
            </div>
            <div class="address-info">
              <h4 class="section-subtitle">Service Address</h4>
              <p class="address">
                {{ booking.address }}<br>
                {{ booking.city }}, {{ booking.state }} {{ booking.zip_code }}
              </p>
              <p class="distance" *ngIf="booking.distance_miles">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                {{ booking.distance_miles }} miles from business
              </p>
            </div>
          </div>

          <!-- Booking Notes (Editable) -->
          <div class="notes-section">
            <h4 class="section-subtitle">Booking Notes</h4>
            <textarea
              *ngIf="editMode"
              [(ngModel)]="editingFields.notes"
              class="notes-textarea"
              rows="3"
              placeholder="Add notes about this booking..."></textarea>
            <p *ngIf="!editMode" class="notes-text">{{ booking.notes || 'No notes provided' }}</p>
          </div>
        </div>

        <!-- Pet Information -->
        <div class="card">
          <div class="card-header">
            <h2>Pet Information</h2>
          </div>
          <div *ngFor="let petBooking of booking.pets" class="pet-card">
            <div class="pet-header">
              <img
                *ngIf="petBooking.pet?.photo_url"
                [src]="getPetPhotoUrl(petBooking.pet?.photo_url)"
                alt="Pet photo"
                class="pet-photo">
              <div class="pet-basic-info">
                <h3>{{ petBooking.pet?.name }}</h3>
                <p class="pet-breed">{{ petBooking.pet?.breed }}</p>
                <div class="pet-badges">
                  <span class="badge" [ngClass]="getSizeBadgeClass(petBooking.service_size)">
                    {{ petBooking.service_size | uppercase }}
                  </span>
                  <span class="badge package-badge" [ngClass]="'package-' + petBooking.package_type">
                    {{ petBooking.package_type | titlecase }}
                  </span>
                </div>
              </div>
              <div class="pet-pricing">
                <div class="price-row">
                  <span class="label">Package:</span>
                  <span class="value">${{ petBooking.package_price }}</span>
                </div>
                <div class="price-row" *ngIf="petBooking.base_price !== petBooking.package_price">
                  <span class="label">Base Price:</span>
                  <span class="value">${{ petBooking.base_price }}</span>
                </div>
                <div class="price-row total-price">
                  <span class="label">Total:</span>
                  <span class="value">${{ petBooking.total_price }}</span>
                </div>
              </div>
            </div>

            <!-- Add-ons -->
            <div *ngIf="petBooking.addons && petBooking.addons.length > 0" class="addons-section">
              <h4 class="section-subtitle">Add-ons</h4>
              <div class="addons-list">
                <div *ngFor="let addon of petBooking.addons" class="addon-item">
                  <span class="addon-name">{{ addon.addon_name }}</span>
                  <span class="addon-price">${{ addon.addon_price }}</span>
                </div>
              </div>
            </div>

            <!-- Enhanced Pet Health Information -->
            <div class="pet-health-info">
              <h4 class="section-subtitle">Health & Behavior</h4>

              <div class="health-grid">
                <!-- Age -->
                <div class="health-item" *ngIf="petBooking.pet?.age">
                  <span class="health-label">Age:</span>
                  <span class="health-value">{{ petBooking.pet?.age }}</span>
                </div>

                <!-- Friendly Status -->
                <div class="health-item">
                  <span class="health-label">Friendly:</span>
                  <span class="health-value" [ngClass]="petBooking.pet?.is_friendly ? 'text-green-600' : 'text-red-600'">
                    {{ petBooking.pet?.is_friendly ? 'Yes ✓' : 'No ✗' }}
                  </span>
                </div>

                <!-- Allergies -->
                <div class="health-item">
                  <span class="health-label">Allergies:</span>
                  <span class="health-value" [ngClass]="petBooking.pet?.has_allergies ? 'text-orange-600' : 'text-green-600'">
                    {{ petBooking.pet?.has_allergies ? 'Yes' : 'None' }}
                  </span>
                </div>
                <div class="health-detail" *ngIf="petBooking.pet?.has_allergies && petBooking.pet?.allergy_details">
                  <p class="detail-text">{{ petBooking.pet?.allergy_details }}</p>
                </div>

                <!-- Skin Conditions -->
                <div class="health-item">
                  <span class="health-label">Skin Conditions:</span>
                  <span class="health-value" [ngClass]="petBooking.pet?.has_skin_conditions ? 'text-orange-600' : 'text-green-600'">
                    {{ petBooking.pet?.has_skin_conditions ? 'Yes' : 'None' }}
                  </span>
                </div>
                <div class="health-detail" *ngIf="petBooking.pet?.has_skin_conditions && petBooking.pet?.skin_condition_details">
                  <p class="detail-text">{{ petBooking.pet?.skin_condition_details }}</p>
                </div>

                <!-- Behavioral Issues -->
                <div class="health-item">
                  <span class="health-label">Behavioral Issues:</span>
                  <span class="health-value" [ngClass]="petBooking.pet?.has_behavioral_issues ? 'text-orange-600' : 'text-green-600'">
                    {{ petBooking.pet?.has_behavioral_issues ? 'Yes' : 'None' }}
                  </span>
                </div>
                <div class="health-detail" *ngIf="petBooking.pet?.has_behavioral_issues && petBooking.pet?.behavioral_issue_details">
                  <p class="detail-text">{{ petBooking.pet?.behavioral_issue_details }}</p>
                </div>

                <!-- Reactions -->
                <div class="health-item" *ngIf="petBooking.pet?.blow_dryer_reaction">
                  <span class="health-label">Blow Dryer Reaction:</span>
                  <span class="health-value">{{ petBooking.pet?.blow_dryer_reaction | titlecase }}</span>
                </div>

                <div class="health-item" *ngIf="petBooking.pet?.water_reaction">
                  <span class="health-label">Water Reaction:</span>
                  <span class="health-value">{{ petBooking.pet?.water_reaction | titlecase }}</span>
                </div>
              </div>

              <!-- Additional Notes -->
              <div class="pet-notes" *ngIf="petBooking.pet?.additional_notes || petBooking.pet?.special_notes">
                <h5 class="notes-label">Additional Notes:</h5>
                <p class="notes-text">{{ petBooking.pet?.additional_notes || petBooking.pet?.special_notes }}</p>
              </div>

              <!-- Pet-specific booking notes -->
              <div class="pet-notes" *ngIf="petBooking.notes">
                <h5 class="notes-label">Booking-specific Notes:</h5>
                <p class="notes-text">{{ petBooking.notes }}</p>
              </div>

              <!-- Rabies Certificate -->
              <div class="certificate-section" *ngIf="petBooking.pet?.rabies_certificate_url">
                <button
                  (click)="viewRabiesCertificate(petBooking.pet?.rabies_certificate_url!)"
                  class="certificate-link">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  View Rabies Certificate
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Service Details -->
        <div class="card">
          <div class="card-header">
            <h2>Service Details</h2>
          </div>
          <div class="service-details">
            <div class="info-row">
              <span class="label">Service Name:</span>
              <span class="value">{{ booking.service_name || 'Grooming Service' }}</span>
            </div>
            <div class="info-row" *ngIf="booking.service_description">
              <span class="label">Description:</span>
              <span class="value">{{ booking.service_description }}</span>
            </div>
            <div class="info-row" *ngIf="booking.service_duration">
              <span class="label">Estimated Duration:</span>
              <span class="value">{{ booking.service_duration }} minutes</span>
            </div>
            <div class="info-row" *ngIf="booking.rush_service">
              <span class="label">Rush Service:</span>
              <span class="value text-orange-600">Yes (+${{ booking.rush_fee }})</span>
            </div>
          </div>
        </div>

        <!-- Payment Information -->
        <div class="card">
          <div class="card-header">
            <h2>Payment Information</h2>
            <span class="status-badge" [ngClass]="booking.payment_status === 'authorized' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'">
              {{ booking.payment_status | titlecase }}
            </span>
          </div>

          <div class="payment-details">
            <!-- Pricing Breakdown -->
            <div class="price-breakdown">
              <div class="price-row">
                <span class="label">Original Subtotal:</span>
                <span class="value">${{ booking.original_subtotal }}</span>
              </div>
              <div class="price-row" *ngIf="booking.discount_amount && booking.discount_amount > 0">
                <span class="label text-green-600">Discount:</span>
                <span class="value text-green-600">-${{ booking.discount_amount }}</span>
              </div>
              <div class="price-row">
                <span class="label">Subtotal Before Tax:</span>
                <span class="value">${{ booking.subtotal_before_tax }}</span>
              </div>
              <div class="price-row">
                <span class="label">Tax ({{ booking.tax_rate ? (booking.tax_rate * 100).toFixed(2) + '%' : 'Tax' }}):</span>
                <span class="value">${{ booking.tax_amount }}</span>
              </div>
              <div class="price-row">
                <span class="label">Service Fee:</span>
                <span class="value">${{ booking.service_fee }}</span>
              </div>
              <div class="price-row">
                <span class="label">Processing Fee:</span>
                <span class="value">${{ booking.processing_fee }}</span>
              </div>
              <div class="price-row total">
                <span class="label">Total Amount:</span>
                <span class="value">${{ booking.authorized_amount || booking.total_amount }}</span>
              </div>
              <div class="price-row" *ngIf="booking.tip_amount && booking.tip_amount > 0">
                <span class="label">Tip:</span>
                <span class="value">${{ booking.tip_amount }}</span>
              </div>
            </div>

            <!-- Payment Method -->
            <div class="payment-method" *ngIf="booking.payment_method_type">
              <h4 class="section-subtitle">Payment Method</h4>
              <div class="info-row">
                <span class="label">Type:</span>
                <span class="value">{{ booking.payment_method_type | titlecase }}</span>
              </div>
              <div class="info-row" *ngIf="booking.payment_method_last4">
                <span class="label">Last 4 Digits:</span>
                <span class="value">•••• {{ booking.payment_method_last4 }}</span>
              </div>
              <div class="info-row">
                <span class="label">Currency:</span>
                <span class="value">{{ booking.currency?.toUpperCase() || 'USD' }}</span>
              </div>
            </div>

            <!-- Transaction IDs -->
            <div class="transaction-ids">
              <h4 class="section-subtitle">Transaction Details</h4>
              <div class="info-row" *ngIf="booking.payment_intent_id">
                <span class="label">Payment Intent:</span>
                <span class="value code">{{ booking.payment_intent_id }}</span>
              </div>
              <div class="info-row" *ngIf="booking.stripe_charge_id">
                <span class="label">Charge ID:</span>
                <span class="value code">{{ booking.stripe_charge_id }}</span>
              </div>
              <div class="info-row" *ngIf="booking.stripe_customer_id">
                <span class="label">Customer ID:</span>
                <span class="value code">{{ booking.stripe_customer_id }}</span>
              </div>
              <div class="info-row" *ngIf="booking.tip_payment_intent_id">
                <span class="label">Tip Payment Intent:</span>
                <span class="value code">{{ booking.tip_payment_intent_id }}</span>
              </div>
            </div>

            <!-- Payment Actions -->
            <div class="payment-actions" *ngIf="booking.payment_intent_id">
              <h4 class="section-subtitle">Payment Actions</h4>

              <!-- Success/Error Messages -->
              <div *ngIf="paymentSuccess" class="alert alert-success">
                {{ paymentSuccess }}
              </div>
              <div *ngIf="paymentError" class="alert alert-error">
                {{ paymentError }}
              </div>

              <div class="action-buttons">
                <!-- Capture Payment Button -->
                <button
                  *ngIf="booking.payment_status === 'authorized' && !booking.payment_captured_at"
                  (click)="openCaptureModal()"
                  class="btn btn-capture">
                  Capture Payment (${{ booking.total_amount }})
                </button>

                <!-- Add Tip Button -->
                <button
                  *ngIf="booking.payment_captured_at && !booking.tip_amount && booking.payment_method_id"
                  (click)="openTipModal()"
                  class="btn btn-secondary">
                  Add Tip
                </button>

                <!-- Payment Already Captured Notice -->
                <span *ngIf="booking.payment_captured_at" class="captured-notice">
                  Payment captured on {{ booking.payment_captured_at | date:'short' }}
                </span>
              </div>
            </div>

            <!-- Groomer Earnings Breakdown -->
            <div class="earnings-breakdown" *ngIf="earningsBreakdown">
              <h4 class="section-subtitle">Groomer Earnings Breakdown</h4>

              <div class="earnings-grid">
                <div class="earnings-row">
                  <span class="label">Service Gross:</span>
                  <span class="value">${{ earningsBreakdown.service_amount_gross?.toFixed(2) }}</span>
                </div>
                <div class="earnings-row">
                  <span class="label">Stripe Fee:</span>
                  <span class="value text-red">-${{ earningsBreakdown.service_stripe_fee?.toFixed(2) }}</span>
                </div>
                <div class="earnings-row">
                  <span class="label">Commission ({{ (earningsBreakdown.commission_rate * 100).toFixed(0) }}%):</span>
                  <span class="value">${{ earningsBreakdown.service_commission?.toFixed(2) }}</span>
                </div>
                <div class="earnings-row" *ngIf="earningsBreakdown.tip_amount > 0">
                  <span class="label">Tip (Net of fees):</span>
                  <span class="value text-green">${{ earningsBreakdown.tip_amount_net?.toFixed(2) }}</span>
                </div>
                <div class="earnings-row total">
                  <span class="label">Total Groomer Payout:</span>
                  <span class="value">${{ earningsBreakdown.groomer_amount?.toFixed(2) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Capture Payment Modal -->
        <div class="modal-overlay" *ngIf="showCaptureModal" (click)="closeCaptureModal()">
          <div class="capture-modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
              <h3>Capture Payment</h3>
              <button class="modal-close" (click)="closeCaptureModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>

            <div class="modal-body">
              <p class="modal-description">Capture the payment for this completed service. You can optionally add a tip amount.</p>

              <div class="payment-summary">
                <div class="summary-row">
                  <span class="summary-label">Service Amount:</span>
                  <span class="summary-value">${{ captureAmount.toFixed(2) }}</span>
                </div>
                <div class="summary-row tip-row">
                  <span class="summary-label">Tip Amount:</span>
                  <div class="tip-input-wrapper">
                    <span class="currency-prefix">$</span>
                    <input
                      type="number"
                      [(ngModel)]="captureTipAmount"
                      min="0"
                      step="0.01"
                      placeholder="0.00"
                      class="tip-input">
                  </div>
                </div>
                <div class="summary-row total-row">
                  <span class="summary-label">Total to Capture:</span>
                  <span class="summary-value total">${{ (captureAmount + (captureTipAmount || 0)).toFixed(2) }}</span>
                </div>
              </div>

              <div *ngIf="paymentError" class="alert alert-error">
                {{ paymentError }}
              </div>
            </div>

            <div class="modal-footer">
              <button (click)="closeCaptureModal()" class="btn btn-secondary">Cancel</button>
              <button
                (click)="capturePayment()"
                [disabled]="isCapturingPayment"
                class="btn btn-capture-confirm">
                {{ isCapturingPayment ? 'Processing...' : 'Capture $' + (captureAmount + (captureTipAmount || 0)).toFixed(2) }}
              </button>
            </div>
          </div>
        </div>

        <!-- Tip Modal -->
        <div class="modal-overlay" *ngIf="showTipModal" (click)="closeTipModal()">
          <div class="modal-content" (click)="$event.stopPropagation()">
            <h3>Add Tip</h3>
            <p>Enter the tip amount to charge to the client's card.</p>

            <div class="form-group">
              <label>Tip Amount ($)</label>
              <input
                type="number"
                [(ngModel)]="tipAmount"
                min="0"
                step="0.01"
                placeholder="0.00"
                class="form-input">
            </div>

            <div *ngIf="paymentError" class="alert alert-error">
              {{ paymentError }}
            </div>

            <div class="modal-actions">
              <button (click)="closeTipModal()" class="btn btn-secondary">Cancel</button>
              <button
                (click)="processTip()"
                [disabled]="isProcessingTip || tipAmount <= 0"
                class="btn btn-primary">
                {{ isProcessingTip ? 'Processing...' : 'Charge Tip' }}
              </button>
            </div>
          </div>
        </div>

        <!-- Groomer Assignment (for pending bookings without groomer) -->
        <div class="card groomer-assignment-card" *ngIf="booking.status === 'pending' && !booking.groomer">
          <div class="card-header">
            <h2>Assign Groomer</h2>
            <span class="status-badge bg-yellow-100 text-yellow-800">Needs Assignment</span>
          </div>

          <div class="assignment-container">
            <p class="assignment-description">
              This booking is pending groomer assignment. Select a date, groomer, and time slot to approve and confirm the booking.
            </p>

            <button
              *ngIf="!showAssignmentForm"
              (click)="showGroomerAssignment()"
              class="btn-assign">
              Assign Groomer & Approve Booking
            </button>

            <!-- Assignment Form -->
            <div *ngIf="showAssignmentForm" class="assignment-form">
              <!-- Date Selection -->
              <div class="form-group">
                <label class="form-label">Scheduled Date</label>
                <input
                  type="date"
                  [(ngModel)]="selectedDate"
                  [min]="minDate"
                  [max]="maxDate"
                  (change)="onDateChange()"
                  class="form-input"
                  required>
              </div>

              <!-- Groomer Selection -->
              <div class="form-group">
                <label class="form-label">Select Groomer</label>
                <select
                  [(ngModel)]="selectedGroomerId"
                  class="form-select"
                  [disabled]="!selectedDate || availableGroomers.length === 0"
                  required>
                  <option value="">-- Choose a groomer --</option>
                  <option *ngFor="let groomer of availableGroomers" [value]="groomer.id">
                    {{ groomer.first_name }} {{ groomer.last_name }}
                  </option>
                </select>
                <p *ngIf="selectedDate && availableGroomers.length === 0" class="form-help-text text-red-600">
                  No groomers available for this date
                </p>
              </div>

              <!-- Time Slot Selection -->
              <div class="form-group">
                <label class="form-label">Select Time Slot</label>

                <div class="time-slots-section">
                  <h4 class="shift-title">Morning Shift (8:30 AM - 12:15 PM)</h4>
                  <div class="time-slots-grid">
                    <button
                      *ngFor="let slot of morningSlots"
                      (click)="selectTimeSlot(slot)"
                      [class.selected]="selectedTimeSlot?.start === slot.start"
                      [disabled]="!selectedGroomerId"
                      class="time-slot-btn">
                      {{ slot.label }}
                    </button>
                  </div>
                </div>

                <div class="time-slots-section">
                  <h4 class="shift-title">Afternoon Shift (1:00 PM - 5:00 PM)</h4>
                  <div class="time-slots-grid">
                    <button
                      *ngFor="let slot of afternoonSlots"
                      (click)="selectTimeSlot(slot)"
                      [class.selected]="selectedTimeSlot?.start === slot.start"
                      [disabled]="!selectedGroomerId"
                      class="time-slot-btn">
                      {{ slot.label }}
                    </button>
                  </div>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="form-actions">
                <button
                  (click)="assignGroomerAndApprove()"
                  [disabled]="!selectedDate || !selectedGroomerId || !selectedTimeSlot || assigningGroomer"
                  class="btn-approve">
                  {{ assigningGroomer ? 'Approving...' : 'Approve Booking' }}
                </button>
                <button
                  (click)="openRejectDialog()"
                  class="btn-reject">
                  Reject Booking
                </button>
                <button
                  (click)="hideAssignmentForm()"
                  class="btn-cancel-assignment">
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Groomer Information -->
        <div class="card" *ngIf="booking.groomer">
          <div class="card-header">
            <h2>Groomer Information</h2>
          </div>
          <div class="groomer-info">
            <div class="avatar-section">
              <div class="avatar" *ngIf="!booking.groomer.avatar_url">
                {{ booking.groomer.first_name[0] }}{{ booking.groomer.last_name[0] }}
              </div>
              <img *ngIf="booking.groomer.avatar_url" [src]="booking.groomer.avatar_url" alt="Groomer avatar" class="avatar-img">
              <div>
                <h3>{{ booking.groomer.first_name }} {{ booking.groomer.last_name }}</h3>
                <p class="text-sm text-gray-600">Groomer ID: {{ booking.groomer.id }}</p>
              </div>
            </div>
            <div class="contact-info">
              <div class="info-row">
                <span class="label">Email:</span>
                <a [href]="'mailto:' + booking.groomer.email" class="value link">{{ booking.groomer.email }}</a>
              </div>
              <div class="info-row">
                <span class="label">Phone:</span>
                <a [href]="'tel:' + booking.groomer.phone" class="value link">{{ booking.groomer.phone }}</a>
              </div>
            </div>
          </div>

          <!-- Groomer Notes (Editable) -->
          <div class="notes-section">
            <h4 class="section-subtitle">Groomer Notes</h4>
            <textarea
              *ngIf="editMode"
              [(ngModel)]="editingFields.groomer_notes"
              class="notes-textarea"
              rows="3"
              placeholder="Add groomer notes..."></textarea>
            <p *ngIf="!editMode" class="notes-text">{{ booking.groomer_notes || 'No groomer notes' }}</p>
          </div>
        </div>

        <!-- Before/After Photos -->
        <div class="card" *ngIf="(booking.before_photos && booking.before_photos.length > 0) || (booking.after_photos && booking.after_photos.length > 0)">
          <div class="card-header">
            <h2>Service Photos</h2>
          </div>

          <div class="photos-section">
            <div *ngIf="booking.before_photos && booking.before_photos.length > 0">
              <h4 class="section-subtitle">Before Photos</h4>
              <div class="photo-grid">
                <img
                  *ngFor="let photo of booking.before_photos"
                  [src]="photo"
                  alt="Before photo"
                  class="photo-thumbnail"
                  (click)="openPhotoGallery(photo)">
              </div>
            </div>

            <div *ngIf="booking.after_photos && booking.after_photos.length > 0">
              <h4 class="section-subtitle">After Photos</h4>
              <div class="photo-grid">
                <img
                  *ngFor="let photo of booking.after_photos"
                  [src]="photo"
                  alt="After photo"
                  class="photo-thumbnail"
                  (click)="openPhotoGallery(photo)">
              </div>
            </div>
          </div>
        </div>

        <!-- Cancellation Info -->
        <div class="card alert-card" *ngIf="booking.cancelled_at">
          <div class="card-header">
            <h2>Cancellation Information</h2>
          </div>
          <div class="cancellation-info">
            <div class="info-row">
              <span class="label">Cancelled At:</span>
              <span class="value">{{ formatDateTime(booking.cancelled_at) }}</span>
            </div>
            <div class="info-row" *ngIf="booking.cancellation_reason">
              <span class="label">Reason:</span>
              <span class="value">{{ booking.cancellation_reason }}</span>
            </div>
          </div>
        </div>

        <!-- Save Changes Button (Edit Mode) -->
        <div *ngIf="editMode" class="edit-actions">
          <button (click)="saveChanges()" class="btn-save">Save Changes</button>
          <button (click)="toggleEditMode()" class="btn-cancel">Cancel</button>
        </div>
      </div>

      <!-- Sidebar Column -->
      <div class="sidebar-column">
        <!-- Admin Notes -->
        <div class="card">
          <div class="card-header">
            <h2>Admin Notes</h2>
          </div>

          <!-- Add Note Form -->
          <div class="add-note-form">
            <textarea
              [(ngModel)]="newNote"
              placeholder="Add an internal note..."
              class="note-input"
              rows="3"></textarea>
            <div class="note-form-footer">
              <select [(ngModel)]="newNotePriority" class="priority-select">
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
                <option value="urgent">Urgent</option>
              </select>
              <button
                (click)="saveNote()"
                [disabled]="!newNote.trim() || savingNote"
                class="btn-add-note">
                {{ savingNote ? 'Saving...' : 'Add Note' }}
              </button>
            </div>
          </div>

          <!-- Notes List -->
          <div class="notes-list">
            <div *ngFor="let note of adminNotes" class="note-item">
              <div class="note-header">
                <span class="note-author">
                  {{ note.admin?.first_name }} {{ note.admin?.last_name }}
                </span>
                <span class="note-priority" [ngClass]="getPriorityBadgeClass(note.priority || 'medium')">
                  {{ note.priority || 'medium' }}
                </span>
              </div>
              <p class="note-content">{{ note.note }}</p>
              <div class="note-footer">
                <span class="note-date">{{ formatDateTime(note.created_at) }}</span>
                <button (click)="deleteNote(note.id)" class="btn-delete-note">Delete</button>
              </div>
            </div>
            <p *ngIf="adminNotes.length === 0" class="no-notes">No admin notes yet</p>
          </div>
        </div>

        <!-- Activity Log -->
        <div class="card" *ngIf="modifications.length > 0">
          <div class="card-header">
            <h2>Activity Log</h2>
          </div>
          <div class="activity-list">
            <div *ngFor="let mod of modifications" class="activity-item">
              <div class="activity-header">
                <span class="activity-type">{{ mod.modification_type | titlecase }}</span>
                <span class="activity-date">{{ formatDateTime(mod.created_at) }}</span>
              </div>
              <p *ngIf="mod.modified_by" class="activity-user">
                By: {{ mod.modified_by.first_name }} {{ mod.modified_by.last_name }}
              </p>
              <p *ngIf="mod.reason" class="activity-reason">{{ mod.reason }}</p>
              <div *ngIf="mod.price_change !== 0" class="activity-price">
                Price Change: <span [ngClass]="mod.price_change > 0 ? 'text-green-600' : 'text-red-600'">
                  {{ mod.price_change > 0 ? '+' : '' }}${{ mod.price_change }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reject Booking Dialog -->
  <div *ngIf="showRejectDialog" class="reject-dialog-overlay" (click)="closeRejectDialog()">
    <div class="reject-dialog" (click)="$event.stopPropagation()">
      <div class="reject-dialog-header">
        <h3>Reject Booking</h3>
        <button (click)="closeRejectDialog()" class="dialog-close">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="reject-dialog-body">
        <p class="reject-warning">Are you sure you want to reject this booking? This action cannot be undone.</p>
        <label class="form-label">Rejection Reason (required)</label>
        <textarea
          [(ngModel)]="rejectionReason"
          class="rejection-textarea"
          rows="4"
          placeholder="Please provide a reason for rejecting this booking..."
          required></textarea>
      </div>
      <div class="reject-dialog-footer">
        <button
          (click)="confirmReject()"
          [disabled]="!rejectionReason.trim()"
          class="btn-confirm-reject">
          Confirm Rejection
        </button>
        <button (click)="closeRejectDialog()" class="btn-cancel-dialog">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Photo Gallery Lightbox -->
  <div *ngIf="photoGalleryOpen" class="photo-lightbox" (click)="closePhotoGallery()">
    <div class="lightbox-content" (click)="$event.stopPropagation()">
      <button class="lightbox-close" (click)="closePhotoGallery()">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      <button class="lightbox-prev" (click)="navigatePhoto('prev')">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <img [src]="selectedPhoto" alt="Full size photo" class="lightbox-image">
      <button class="lightbox-next" (click)="navigatePhoto('next')">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Change Request Reject Modal -->
  <div *ngIf="showChangeRequestRejectModal" class="reject-dialog-overlay" (click)="closeChangeRequestRejectModal()">
    <div class="reject-dialog" (click)="$event.stopPropagation()">
      <div class="reject-dialog-header">
        <h3>Reject Time Change Request</h3>
        <button (click)="closeChangeRequestRejectModal()" class="dialog-close">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="reject-dialog-body">
        <p class="reject-warning">Are you sure you want to reject this time change request? The customer will be notified of your decision.</p>
        <label class="form-label">Reason for Rejection (optional)</label>
        <textarea
          [(ngModel)]="changeRequestRejectReason"
          class="rejection-textarea"
          rows="4"
          placeholder="Provide a reason for rejecting this request (e.g., groomer unavailable, time slot conflicts)..."></textarea>
      </div>
      <div class="reject-dialog-footer">
        <button
          (click)="confirmRejectChangeRequest()"
          [disabled]="processingChangeRequest"
          class="btn-confirm-reject">
          {{ processingChangeRequest ? 'Processing...' : 'Confirm Rejection' }}
        </button>
        <button (click)="closeChangeRequestRejectModal()" class="btn-cancel-dialog">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Time Change Modal -->
  <div *ngIf="showTimeChangeModal" class="time-change-overlay" (click)="closeTimeChangeModal()">
    <div class="time-change-dialog" (click)="$event.stopPropagation()">
      <div class="time-change-dialog-header">
        <h3>Change Booking Date/Time</h3>
        <button (click)="closeTimeChangeModal()" class="dialog-close">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div class="time-change-dialog-body">
        <!-- Current Schedule Display -->
        <div class="current-schedule-box">
          <h4 class="current-schedule-title">Current Schedule</h4>
          <div class="current-schedule-info">
            <div class="schedule-detail">
              <span class="schedule-label">Date:</span>
              <span class="schedule-value">{{ formatDate(booking?.scheduled_date || '') }}</span>
            </div>
            <div class="schedule-detail">
              <span class="schedule-label">Time:</span>
              <span class="schedule-value">
                {{ formatTime(booking?.scheduled_time_start || '') }} - {{ formatTime(booking?.scheduled_time_end || '') }}
              </span>
            </div>
          </div>
        </div>

        <!-- New Date Selection -->
        <div class="form-group">
          <label class="form-label">New Date *</label>
          <input
            type="date"
            [(ngModel)]="newScheduledDate"
            [min]="minDate"
            [max]="maxDate"
            class="form-input"
            required>
        </div>

        <!-- Time Slot Selection -->
        <div class="form-group" *ngIf="newScheduledDate">
          <label class="form-label">New Time Slot *</label>

          <div class="time-slots-section">
            <h4 class="shift-title">Morning Shift</h4>
            <div class="time-slots-grid">
              <button
                *ngFor="let slot of morningSlots"
                (click)="selectNewTimeSlot(slot)"
                [class.selected]="newTimeSlot?.start === slot.start"
                class="time-slot-btn">
                {{ slot.label }}
              </button>
            </div>
          </div>

          <div class="time-slots-section">
            <h4 class="shift-title">Afternoon Shift</h4>
            <div class="time-slots-grid">
              <button
                *ngFor="let slot of afternoonSlots"
                (click)="selectNewTimeSlot(slot)"
                [class.selected]="newTimeSlot?.start === slot.start"
                class="time-slot-btn">
                {{ slot.label }}
              </button>
            </div>
          </div>
        </div>

        <!-- Reason (Required) -->
        <div class="form-group">
          <label class="form-label">Reason for Change *</label>
          <textarea
            [(ngModel)]="timeChangeReason"
            class="reason-textarea"
            rows="3"
            placeholder="Explain why the booking time is being changed (e.g., customer requested change, scheduling conflict)..."
            required></textarea>
          <p class="form-help-text">This reason will be included in the notification emails sent to the customer and groomer.</p>
        </div>
      </div>

      <div class="time-change-dialog-footer">
        <button
          (click)="confirmTimeChange()"
          [disabled]="!newScheduledDate || !newTimeSlot || !timeChangeReason.trim() || savingTimeChange"
          class="btn-confirm-change">
          {{ savingTimeChange ? 'Saving...' : 'Confirm Change & Notify' }}
        </button>
        <button (click)="closeTimeChangeModal()" class="btn-cancel-dialog">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

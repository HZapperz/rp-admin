<div class="select-date-time-step">
  <!-- No Groomer Selected -->
  <div *ngIf="!selectedGroomer" class="info-state">
    <mat-icon class="info-icon">person</mat-icon>
    <p>Please select a groomer first</p>
    <small>You must select a groomer before choosing a date and time</small>
  </div>

  <!-- Date Time Selection -->
  <div *ngIf="selectedGroomer" class="datetime-content">
    <div class="content-header">
      <h3>Select Date & Time</h3>
      <div class="groomer-info">
        <mat-icon class="groomer-icon" inline>person</mat-icon>
        <span>Booking for: {{ selectedGroomer.first_name }} {{ selectedGroomer.last_name }}</span>
      </div>
    </div>

    <div class="datetime-grid">
      <!-- Calendar Section -->
      <div class="calendar-section">
        <h4>Choose a Date</h4>

        <div class="calendar">
          <!-- Calendar Header -->
          <div class="calendar-header">
            <button class="nav-btn" (click)="previousMonth()">‹</button>
            <span class="month-year">{{ getCurrentMonthYear() }}</span>
            <button class="nav-btn" (click)="nextMonth()">›</button>
          </div>

          <!-- Day Names -->
          <div class="day-names">
            <div *ngFor="let dayName of dayNames" class="day-name">
              {{ dayName }}
            </div>
          </div>

          <!-- Calendar Days -->
          <div class="calendar-days">
            <div
              *ngFor="let date of calendarDays"
              class="calendar-day"
              [class.empty]="!date"
              [class.past]="date && !isDateSelectable(date)"
              [class.today]="isToday(date)"
              [class.selected]="isDateSelected(date)"
              [class.selectable]="date && isDateSelectable(date)"
              (click)="selectDate(date)"
            >
              <span *ngIf="date">{{ date.getDate() }}</span>
            </div>
          </div>
        </div>

        <!-- Selected Date Display -->
        <div class="selected-date-display" *ngIf="selectedDate">
          <mat-icon class="calendar-icon" inline>calendar_today</mat-icon>
          <span class="date-text">{{ formatDateDisplay(selectedDate) }}</span>
        </div>
      </div>

      <!-- Time Slot Section -->
      <div class="timeslots-section">
        <div class="time-section-header">
          <h4>Select Time</h4>
        </div>

        <div *ngIf="!selectedDate" class="no-date-message">
          <mat-icon class="clock-icon" inline>schedule</mat-icon>
          <p>Please select a date first</p>
        </div>

        <!-- Loading State -->
        <div *ngIf="selectedDate && isLoadingSlots" class="slots-loading">
          <div class="spinner-small"></div>
          <span>Loading available time slots...</span>
        </div>

        <!-- Groomer Unavailable Info Banner (non-blocking) -->
        <div *ngIf="selectedDate && !isLoadingSlots && groomerUnavailableReason" class="groomer-info-banner">
          <mat-icon inline>info</mat-icon>
          <span>{{ groomerUnavailableReason }}</span>
        </div>

        <!-- Available Time Slots (always shown when date selected and slots loaded) -->
        <div *ngIf="selectedDate && !isLoadingSlots && availableSlots.length > 0" class="available-slots">
          <div class="slots-grid">
            <button
              *ngFor="let slot of availableSlots"
              class="slot-btn"
              [class.selected]="isSlotSelected(slot)"
              [class.unavailable]="!slot.is_available"
              [title]="slot.conflict_reason || ''"
              (click)="selectSlot(slot)"
              type="button">
              <span class="slot-label">{{ slot.label }}</span>
              <span class="slot-time">{{ slot.display_time }}</span>
              <span *ngIf="!slot.is_available" class="busy-badge">Busy</span>
            </button>
          </div>

          <!-- No available slots warning -->
          <div *ngIf="!hasAvailableSlots()" class="no-slots-warning">
            <mat-icon inline>info</mat-icon>
            <span>All time slots are booked for this date. Use custom time below if needed.</span>
          </div>

          <!-- Custom Time Toggle -->
          <div class="custom-time-toggle">
            <button class="toggle-custom-btn" (click)="toggleCustomTime()" type="button">
              <mat-icon inline>{{ useCustomTime ? 'close' : 'edit' }}</mat-icon>
              {{ useCustomTime ? 'Use Available Slots' : 'Enter Custom Time' }}
            </button>
          </div>
        </div>

        <!-- Custom Time Inputs (when no slots or custom time enabled) -->
        <div *ngIf="selectedDate && !isLoadingSlots && (useCustomTime || availableSlots.length === 0)" class="custom-time-section">
          <div class="custom-time-header">
            <h5>Custom Time Entry</h5>
            <button class="help-btn" (click)="toggleTimeHelp()" type="button">
              <mat-icon inline>help_outline</mat-icon>
            </button>
          </div>

          <!-- Time Help Modal -->
          <div class="time-help-modal" *ngIf="showTimeHelp">
            <div class="help-header">
              <span>Accepted Time Formats</span>
              <button class="close-btn" (click)="toggleTimeHelp()" type="button">
                <mat-icon inline>close</mat-icon>
              </button>
            </div>
            <div class="help-content">
              <ul>
                <li><code>930am</code> or <code>9:30am</code></li>
                <li><code>1230pm</code> or <code>12:30pm</code></li>
                <li><code>12.30pm</code> (dot notation)</li>
                <li><code>9:30 AM</code> (with spaces)</li>
                <li><code>930</code> or <code>1230</code> (auto-detects AM/PM)</li>
              </ul>
              <p class="help-note">Times auto-format when you click out of the field.</p>
            </div>
          </div>

          <div class="time-inputs">
            <div class="time-input-group">
              <label class="time-label">Start Time</label>
              <input
                type="text"
                class="time-input"
                [(ngModel)]="startTime"
                placeholder="e.g., 9:30 AM or 930am"
                (ngModelChange)="onTimeChange()"
                (blur)="onStartTimeBlur()"
              >
            </div>
            <div class="time-input-group">
              <label class="time-label">End Time</label>
              <input
                type="text"
                class="time-input"
                [(ngModel)]="endTime"
                placeholder="e.g., 11:00 AM or 1100am"
                (ngModelChange)="onTimeChange()"
                (blur)="onEndTimeBlur()"
              >
            </div>
          </div>
        </div>

        <!-- Selected Time Display -->
        <div class="selected-time-display" *ngIf="isTimeValid()">
          <mat-icon class="clock-icon" inline>schedule</mat-icon>
          <span class="time-text">{{ startTime }} - {{ endTime }}</span>
        </div>
      </div>
    </div>

    <!-- Summary -->
    <div class="datetime-summary" *ngIf="selectedDate && isTimeValid()">
      <mat-icon class="summary-icon">check_circle</mat-icon>
      <div class="summary-text">
        <div class="summary-title">Appointment Scheduled</div>
        <div class="summary-details">
          {{ formatDateDisplay(selectedDate) }} - {{ startTime }} to {{ endTime }}
        </div>
      </div>
    </div>

    <!-- Validation Message -->
    <div class="validation-message" *ngIf="selectedDate && !isTimeValid()">
      <mat-icon class="info-icon" inline>info</mat-icon>
      <span>Please enter valid start and end times to continue</span>
    </div>
  </div>
</div>

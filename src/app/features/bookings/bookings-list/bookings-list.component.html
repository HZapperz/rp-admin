<div class="bookings-page">
  <div class="page-header">
    <h1>ðŸ“… Bookings Management</h1>
    <p class="subtitle">Manage and approve customer bookings</p>
  </div>

  <!-- Filters -->
  <div class="filters">
    <div class="filter-group">
      <label for="status">Status:</label>
      <select id="status" (change)="onStatusFilterChange($event)" [value]="selectedStatus">
        <option value="all">All Statuses</option>
        <option value="pending">Pending</option>
        <option value="confirmed">Confirmed</option>
        <option value="in_progress">In Progress</option>
        <option value="completed">Completed</option>
        <option value="cancelled">Cancelled</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="search">Search:</label>
      <input
        type="text"
        id="search"
        placeholder="Search by client, groomer, or ID..."
        (input)="onSearchChange($event)"
        [value]="searchTerm"
      />
    </div>
  </div>

  @if (isLoading) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading bookings...</p>
    </div>
  }

  @if (error) {
    <div class="error-message">{{ error }}</div>
  }

  @if (!isLoading && !error) {
    <div class="bookings-stats">
      <span>Showing {{ filteredBookings.length }} of {{ bookings.length }} bookings</span>
    </div>

    <div class="bookings-table-container">
      <table class="bookings-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Client</th>
            <th>Groomer</th>
            <th>Date & Time</th>
            <th>Service</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @if (filteredBookings.length === 0) {
            <tr>
              <td colspan="8" class="no-bookings">No bookings found</td>
            </tr>
          }
          @for (booking of filteredBookings; track booking.id) {
            <tr>
              <td class="booking-id">{{ booking.id.substring(0, 8) }}...</td>
              <td>
                <div class="user-info">
                  <div class="user-name">
                    {{ booking.client?.first_name }} {{ booking.client?.last_name }}
                  </div>
                </div>
              </td>
              <td>
                @if (booking.groomer) {
                  <div class="user-info">
                    <div class="user-name">
                      {{ booking.groomer.first_name }} {{ booking.groomer.last_name }}
                    </div>
                  </div>
                } @else {
                  <span class="not-assigned">Not assigned</span>
                }
              </td>
              <td>
                <div class="date-time">
                  <div>{{ formatDate(booking.scheduled_date) }}</div>
                  <div class="time">{{ booking.scheduled_time_start }} - {{ booking.scheduled_time_end }}</div>
                </div>
              </td>
              <td>{{ booking.service?.name || 'N/A' }}</td>
              <td class="amount">{{ formatCurrency(booking.total_amount) }}</td>
              <td>
                <span class="status-badge" [ngClass]="getStatusClass(booking.status)">
                  {{ getStatusLabel(booking.status) }}
                </span>
              </td>
              <td class="actions">
                @if (booking.status === 'pending') {
                  <button class="btn btn-approve" (click)="approveBooking(booking)">
                    âœ“ Approve
                  </button>
                  <button class="btn btn-reject" (click)="rejectBooking(booking)">
                    âœ— Reject
                  </button>
                }
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  <!-- Groomer & Time Slot Selection Modal -->
  @if (showGroomerModal && selectedBooking) {
    <div class="modal-overlay" (click)="closeGroomerModal()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Approve Booking & Assign Schedule</h2>
          <button class="close-btn" (click)="closeGroomerModal()">âœ•</button>
        </div>
        <div class="modal-body">
          <!-- Booking Info Summary -->
          <div class="booking-summary">
            <h3>Booking Details</h3>
            <div class="summary-row">
              <span class="label">Client:</span>
              <span class="value">{{ selectedBooking.client?.first_name }} {{ selectedBooking.client?.last_name }}</span>
            </div>
            <div class="summary-row">
              <span class="label">Date:</span>
              <span class="value">{{ formatDate(selectedBooking.scheduled_date) }}</span>
            </div>
            <div class="summary-row">
              <span class="label">Shift Preference:</span>
              <span class="value shift-badge" [class.morning]="selectedBooking.shift_preference === 'morning'" [class.afternoon]="selectedBooking.shift_preference === 'afternoon'">
                {{ selectedBooking.shift_preference === 'morning' ? 'Morning (8:30 AM - 12:15 PM)' : 'Afternoon (1:00 PM - 5:00 PM)' }}
              </span>
            </div>
            <div class="summary-row">
              <span class="label">Service:</span>
              <span class="value">{{ selectedBooking.service_name }}</span>
            </div>
          </div>

          <!-- Step 1: Select Groomer -->
          <div class="modal-section">
            <h3>1. Select Groomer</h3>
            <div class="groomer-grid">
              @for (groomer of availableGroomers; track groomer.id) {
                <div
                  class="groomer-card"
                  [class.selected]="selectedGroomerId === groomer.id"
                  (click)="selectedGroomerId = groomer.id">
                  <div class="groomer-avatar">{{ groomer.first_name?.[0] }}{{ groomer.last_name?.[0] }}</div>
                  <div class="groomer-info">
                    <div class="groomer-name">
                      {{ groomer.first_name }} {{ groomer.last_name }}
                    </div>
                    <div class="groomer-meta">Available</div>
                  </div>
                  @if (selectedGroomerId === groomer.id) {
                    <div class="check-icon">âœ“</div>
                  }
                </div>
              }
              @if (availableGroomers.length === 0) {
                <p class="no-groomers">No groomers available for this date</p>
              }
            </div>
          </div>

          <!-- Step 2: Select Time Slot -->
          <div class="modal-section">
            <h3>2. Assign Time Slot</h3>
            <p class="help-text">Select a specific time slot based on client's shift preference</p>
            <div class="time-slots-grid">
              @for (slot of availableTimeSlots; track slot.time) {
                <div
                  class="time-slot-card"
                  [class.selected]="selectedTimeSlot === slot.time"
                  [class.unavailable]="!slot.available"
                  (click)="slot.available && (selectedTimeSlot = slot.time)">
                  <div class="slot-time">{{ slot.label }}</div>
                  @if (selectedTimeSlot === slot.time) {
                    <div class="check-icon">âœ“</div>
                  }
                  @if (!slot.available) {
                    <div class="unavailable-badge">Booked</div>
                  }
                </div>
              }
            </div>
          </div>

          <!-- Actions -->
          <div class="modal-actions">
            <button class="btn btn-secondary" (click)="closeGroomerModal()">Cancel</button>
            <button
              class="btn btn-primary"
              (click)="assignGroomerAndApprove()"
              [disabled]="!selectedGroomerId || !selectedTimeSlot">
              Approve & Assign
            </button>
          </div>
        </div>
      </div>
    </div>
  }
</div>

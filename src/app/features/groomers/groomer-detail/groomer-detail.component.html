<div class="groomer-detail-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading">
    <div class="spinner"></div>
    <p>Loading groomer details...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="!isLoading && !earningsDetail" class="error-state">
    <h2>Error Loading Groomer</h2>
    <p>Failed to load groomer details</p>
    <button (click)="goBack()" class="btn-back">Back to Groomers</button>
  </div>

  <!-- Groomer Detail Content -->
  <div *ngIf="!isLoading && earningsDetail" class="detail-content">
    <!-- Header -->
    <div class="detail-header">
      <button (click)="goBack()" class="btn-back">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Back to Groomers
      </button>
      <div class="header-info">
        <h1>{{ earningsDetail.groomer.name }}</h1>
        <p class="email">{{ earningsDetail.groomer.email }}</p>
      </div>
    </div>

    <!-- Commission Management Card -->
    <div class="section commission-section">
      <h2 class="section-title">Commission Management</h2>

      <div class="current-commission">
        <label>Current Commission Rate:</label>
        <span class="commission-value">
          {{ formatCommissionRate(earningsDetail.groomer.commissionRate) }}
        </span>
      </div>

      @if (!editingCommission) {
        <button class="edit-btn" (click)="startEditCommission()">
          Edit Commission Rate
        </button>
      }

      @if (editingCommission) {
        <div class="edit-form">
          <div class="form-group">
            <label for="commission-percent">New Commission Rate (%):</label>
            <input
              id="commission-percent"
              type="number"
              [(ngModel)]="newCommissionPercent"
              min="0"
              max="100"
              step="1"
              placeholder="e.g., 35"
            />
            <small>Enter percentage (e.g., 35 for 35%)</small>
          </div>

          <div class="form-group">
            <label for="commission-notes">Notes (optional):</label>
            <textarea
              id="commission-notes"
              [(ngModel)]="commissionNotes"
              placeholder="Reason for rate change..."
              rows="3"
            ></textarea>
          </div>

          <div class="form-actions">
            <button class="save-btn" (click)="saveCommission()" [disabled]="isSaving">
              {{ isSaving ? 'Saving...' : 'Save Changes' }}
            </button>
            <button class="cancel-btn" (click)="cancelEditCommission()">
              Cancel
            </button>
          </div>

          @if (saveError) {
            <div class="error">{{ saveError }}</div>
          }
        </div>
      }

      <!-- Commission History -->
      <div class="commission-history">
        <h3>Commission History</h3>
        @if (commissionHistory.length === 0) {
          <p class="no-history">No rate changes yet</p>
        }
        <div class="history-list">
          @for (change of commissionHistory; track change.id) {
            <div class="history-item">
              <div class="history-header">
                <span class="rate-change">
                  {{ formatCommissionRate(change.old_rate) }} â†’ {{ formatCommissionRate(change.new_rate) }}
                </span>
                <span class="date">{{ formatDate(change.created_at) }}</span>
              </div>
              <div class="history-details">
                <span class="admin">By: {{ change.admin?.first_name }} {{ change.admin?.last_name }}</span>
                @if (change.notes) {
                  <p class="notes">{{ change.notes }}</p>
                }
              </div>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Earnings Summary Card -->
    <div class="section earnings-section">
      <h2 class="section-title">Earnings Summary</h2>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value">{{ earningsDetail.summary.totalBookings }}</div>
          <div class="stat-label">Total Bookings</div>
        </div>
        <div class="stat-card highlight">
          <div class="stat-value">{{ formatCurrency(earningsDetail.summary.totalGrossRevenue) }}</div>
          <div class="stat-label">Gross Revenue</div>
        </div>
        <div class="stat-card negative">
          <div class="stat-value">-{{ formatCurrency(earningsDetail.summary.totalStripeFees) }}</div>
          <div class="stat-label">Stripe Fees</div>
        </div>
        <div class="stat-card positive">
          <div class="stat-value">{{ formatCurrency(earningsDetail.summary.totalNetRevenue) }}</div>
          <div class="stat-label">Net Revenue</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{{ formatCurrency(earningsDetail.summary.totalServiceCommission) }}</div>
          <div class="stat-label">Service Commission</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{{ formatCurrency(earningsDetail.summary.totalTips) }}</div>
          <div class="stat-label">Tips</div>
        </div>
        <div class="stat-card primary">
          <div class="stat-value">{{ formatCurrency(earningsDetail.summary.totalEarnings) }}</div>
          <div class="stat-label">Total Groomer Earnings</div>
        </div>
        <div class="stat-card pending">
          <div class="stat-value">{{ formatCurrency(earningsDetail.summary.pendingPayout) }}</div>
          <div class="stat-label">Pending Payout</div>
        </div>
      </div>
    </div>

    <!-- Recent Earnings -->
    <div class="section earnings-table-section">
      <h2 class="section-title">Recent Earnings (Last 20)</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Client</th>
              <th>Gross</th>
              <th>Stripe Fee</th>
              <th>Commission</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            @if (earningsDetail.earnings.length === 0) {
              <tr>
                <td colspan="6" class="no-earnings">No earnings yet</td>
              </tr>
            }
            @for (earning of earningsDetail.earnings.slice(0, 20); track earning.id) {
              <tr>
                <td>{{ formatDate(earning.booking?.scheduled_date) }}</td>
                <td>{{ earning.booking?.client?.first_name }} {{ earning.booking?.client?.last_name }}</td>
                <td class="currency">{{ formatCurrency(earning.service_amount_gross) }}</td>
                <td class="currency fee">-{{ formatCurrency(earning.total_stripe_fees) }}</td>
                <td class="currency earnings">{{ formatCurrency(earning.groomer_amount) }}</td>
                <td>
                  <span class="status-badge status-{{ earning.status }}">
                    {{ earning.status }}
                  </span>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>


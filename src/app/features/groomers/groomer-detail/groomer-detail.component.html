<div class="groomer-detail-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading">
    <div class="spinner"></div>
    <p>Loading groomer details...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="!isLoading && !earningsDetail" class="error-state">
    <h2>Error Loading Groomer</h2>
    <p>Failed to load groomer details</p>
    <button (click)="goBack()" class="btn-back">Back to Groomers</button>
  </div>

  <!-- Groomer Detail Content -->
  <div *ngIf="!isLoading && earningsDetail" class="detail-content">
    <!-- Header -->
    <div class="detail-header">
      <button (click)="goBack()" class="btn-back">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Back to Groomers
      </button>
      <div class="header-info">
        <h1>{{ earningsDetail.groomer.name }}</h1>
        <p class="email">{{ earningsDetail.groomer.email }}</p>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button
        class="tab-btn"
        [class.active]="activeTab === 'overview'"
        (click)="setTab('overview')">
        <span class="material-icons">person</span>
        Overview
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab === 'payroll'"
        (click)="setTab('payroll')">
        <span class="material-icons">payments</span>
        Payroll
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab === 'availability'"
        (click)="setTab('availability')">
        <span class="material-icons">schedule</span>
        Availability
      </button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Overview Tab -->
      <div *ngIf="activeTab === 'overview'" class="tab-panel">
        <!-- Commission Management Card -->
        <div class="section commission-section">
          <h2 class="section-title">Commission Management</h2>

          <div class="current-commission">
            <label>Current Commission Rate:</label>
            <span class="commission-value">
              {{ formatCommissionRate(earningsDetail.groomer.commissionRate) }}
            </span>
          </div>

          @if (!editingCommission) {
            <button class="edit-btn" (click)="startEditCommission()">
              Edit Commission Rate
            </button>
          }

          @if (editingCommission) {
            <div class="edit-form">
              <div class="form-group">
                <label for="commission-percent">New Commission Rate (%):</label>
                <input
                  id="commission-percent"
                  type="number"
                  [(ngModel)]="newCommissionPercent"
                  min="0"
                  max="100"
                  step="1"
                  placeholder="e.g., 35"
                />
                <small>Enter percentage (e.g., 35 for 35%)</small>
              </div>

              <div class="form-group">
                <label for="commission-notes">Notes (optional):</label>
                <textarea
                  id="commission-notes"
                  [(ngModel)]="commissionNotes"
                  placeholder="Reason for rate change..."
                  rows="3"
                ></textarea>
              </div>

              <div class="form-actions">
                <button class="save-btn" (click)="saveCommission()" [disabled]="isSaving">
                  {{ isSaving ? 'Saving...' : 'Save Changes' }}
                </button>
                <button class="cancel-btn" (click)="cancelEditCommission()">
                  Cancel
                </button>
              </div>

              @if (saveError) {
                <div class="error">{{ saveError }}</div>
              }
            </div>
          }

          <!-- Commission History -->
          <div class="commission-history">
            <h3>Commission History</h3>
            @if (commissionHistory.length === 0) {
              <p class="no-history">No rate changes yet</p>
            }
            <div class="history-list">
              @for (change of commissionHistory; track change.id) {
                <div class="history-item">
                  <div class="history-header">
                    <span class="rate-change">
                      {{ formatCommissionRate(change.old_rate) }} â†’ {{ formatCommissionRate(change.new_rate) }}
                    </span>
                    <span class="date">{{ formatDate(change.created_at) }}</span>
                  </div>
                  <div class="history-details">
                    <span class="admin">By: {{ change.admin?.first_name }} {{ change.admin?.last_name }}</span>
                    @if (change.notes) {
                      <p class="notes">{{ change.notes }}</p>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Payroll Tab -->
      <div *ngIf="activeTab === 'payroll'" class="tab-panel" id="payroll-section">
        <!-- Payroll Header with Export Buttons -->
        <div class="payroll-header">
          <h2 class="section-title">Payroll</h2>
          <div class="export-buttons" *ngIf="payrollData && payrollData.totals.booking_count > 0">
            <button class="export-btn" (click)="exportToCSV()" title="Export to CSV">
              <span class="material-icons">download</span>
              CSV
            </button>
            <button class="export-btn" (click)="exportToExcel()" title="Export for Excel">
              <span class="material-icons">table_chart</span>
              Excel
            </button>
            <button class="export-btn" (click)="printPayroll()" title="Print payroll">
              <span class="material-icons">print</span>
              Print
            </button>
          </div>
        </div>

        <!-- Period Selector -->
        <div class="period-selector-row">
          <app-payroll-period-selector
            *ngIf="availableMonths.length > 0 || selectionMode === 'custom'"
            [availableMonths]="availableMonths"
            [selectedYear]="selectedYear"
            [selectedMonth]="selectedMonth"
            [selectionMode]="selectionMode"
            [customStartDate]="customStartDate"
            [customEndDate]="customEndDate"
            (periodChange)="onPeriodChange($event)"
            (modeChange)="onModeChange($event)"
            (customRangeChange)="onCustomRangeChange($event)">
          </app-payroll-period-selector>
        </div>

        <!-- Loading state -->
        <div *ngIf="isLoadingPayroll" class="payroll-loading">
          <div class="spinner"></div>
          <p>Loading payroll data...</p>
        </div>

        <!-- No data state -->
        <div *ngIf="!isLoadingPayroll && availableMonths.length === 0 && selectionMode === 'monthly'" class="no-payroll">
          <span class="material-icons">payments</span>
          <p>No completed grooms yet</p>
        </div>

        <!-- Payroll content -->
        <div *ngIf="!isLoadingPayroll && payrollData" class="payroll-content">
          <app-payroll-summary-table
            [periodData]="payrollData"
            [commissionRate]="earningsDetail.groomer ? earningsDetail.groomer.commissionRate : 0.35"
            [isCustomRange]="selectionMode === 'custom'"
            (markAsPaid)="openMarkPaidDialog()">
          </app-payroll-summary-table>

          <div class="weeks-container">
            <app-payroll-week-section
              *ngFor="let week of payrollData.weeks; let i = index"
              [weekData]="week"
              [isExpanded]="week.is_expanded"
              (toggleExpandEvent)="toggleWeekExpand(i)">
            </app-payroll-week-section>
          </div>

          <div *ngIf="payrollData.weeks.length === 0" class="no-grooms">
            <p>No completed grooms in this period</p>
          </div>
        </div>
      </div>

      <!-- Availability Tab -->
      <div *ngIf="activeTab === 'availability'" class="tab-panel">
        <!-- Loading state -->
        <div *ngIf="isLoadingAvailability" class="availability-loading">
          <div class="spinner"></div>
          <p>Loading availability...</p>
        </div>

        <!-- Availability content -->
        <div *ngIf="!isLoadingAvailability && availabilityData" class="availability-content">

          <!-- Weekly Schedule -->
          <div class="section weekly-schedule-section">
            <h2 class="section-title">Weekly Schedule</h2>

            <div class="weekly-grid">
              @for (day of DAYS; track day; let i = $index) {
                <div class="day-card">
                  <h3 class="day-name">{{ day }}</h3>
                  <div class="day-slots">
                    @if (getAvailabilityForDay(i).length > 0) {
                      @for (slot of getAvailabilityForDay(i); track slot.id) {
                        <div class="time-slot" [class.available]="slot.is_available">
                          <span class="material-icons slot-icon">schedule</span>
                          <span class="slot-time">
                            {{ formatTimeDisplay(slot.start_time) }} - {{ formatTimeDisplay(slot.end_time) }}
                          </span>
                        </div>
                      }
                    } @else {
                      <div class="no-availability">
                        <span class="material-icons">event_busy</span>
                        <span>Not available</span>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Upcoming Time Off / Blocked Dates -->
          <div class="section exceptions-section">
            <div class="section-header-row">
              <div>
                <h2 class="section-title">Upcoming Time Off / Blocked Dates</h2>
                <p class="section-subtitle">Next {{ availabilityData.date_range.from }} to {{ availabilityData.date_range.to }}</p>
              </div>
              <button class="btn-block-date" (click)="openBlockDateModal()">
                <span class="material-icons">block</span>
                Block a Date
              </button>
            </div>

            @if (availabilityData.exceptions.length > 0) {
              <div class="exceptions-list">
                @for (exception of availabilityData.exceptions; track exception.id) {
                  <div class="exception-card">
                    <div class="exception-date">
                      <span class="material-icons">event</span>
                      {{ formatExceptionDate(exception.exception_date) }}
                    </div>
                    <div class="exception-details">
                      <span class="exception-badge" [ngClass]="getExceptionTypeClass(exception.exception_type)">
                        {{ getExceptionTypeLabel(exception.exception_type) }}
                      </span>
                      @if (exception.start_time && exception.end_time) {
                        <span class="exception-time">
                          {{ formatTimeDisplay(exception.start_time) }} - {{ formatTimeDisplay(exception.end_time) }}
                        </span>
                      } @else {
                        <span class="exception-time all-day">All day</span>
                      }
                    </div>
                    @if (exception.reason) {
                      <div class="exception-reason">{{ exception.reason }}</div>
                    }
                    <button class="btn-remove-exception" (click)="unblockDate(exception.id)" title="Remove block">
                      <span class="material-icons">delete_outline</span>
                    </button>
                  </div>
                }
              </div>
            } @else {
              <div class="no-exceptions">
                <span class="material-icons">event_available</span>
                <p>No upcoming time off or blocked dates</p>
              </div>
            }
          </div>
        </div>

        <!-- Block Date Modal -->
        <div *ngIf="showBlockDateModal" class="modal-overlay" (click)="closeBlockDateModal()">
          <div class="modal-dialog" (click)="$event.stopPropagation()">
            <div class="modal-header">
              <h4>Block a Date</h4>
              <button class="modal-close-btn" (click)="closeBlockDateModal()">
                <span class="material-icons">close</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label for="block-date-input">Date</label>
                <input
                  id="block-date-input"
                  type="date"
                  [(ngModel)]="blockDateInput"
                  class="form-control"
                />
              </div>
              <div class="form-group">
                <label for="block-date-reason">Reason (optional)</label>
                <input
                  id="block-date-reason"
                  type="text"
                  [(ngModel)]="blockDateReason"
                  placeholder="e.g. Fully booked"
                  class="form-control"
                />
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn-cancel" (click)="closeBlockDateModal()">Cancel</button>
              <button
                class="btn-confirm"
                (click)="blockDate()"
                [disabled]="!blockDateInput || isBlockingDate">
                {{ isBlockingDate ? 'Blocking...' : 'Block Date' }}
              </button>
            </div>
          </div>
        </div>

        <!-- No data state -->
        <div *ngIf="!isLoadingAvailability && !availabilityData" class="no-availability-data">
          <span class="material-icons">schedule</span>
          <p>Could not load availability data</p>
        </div>
      </div>
    </div>

    <!-- Mark Paid Dialog -->
    <app-mark-paid-dialog
      [isOpen]="showMarkPaidDialog"
      [periodData]="payrollData"
      [groomerName]="earningsDetail.groomer ? earningsDetail.groomer.name : ''"
      [isSubmitting]="isMarkingPaid"
      (close)="closeMarkPaidDialog()"
      (confirm)="confirmMarkPaid($event)">
    </app-mark-paid-dialog>
  </div>
</div>

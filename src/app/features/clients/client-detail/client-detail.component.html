<div class="client-detail-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <p>Loading client details...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-state">
    <h2>Error Loading Client</h2>
    <p>{{ error }}</p>
    <button (click)="goBack()" class="btn btn-back">Back to Clients</button>
  </div>

  <!-- Client Detail Content -->
  <div *ngIf="!loading && !error && clientData" class="detail-content">
    <!-- Merged Header Bar -->
    <div class="header-bar">
      <div class="header-left">
        <button (click)="goBack()" class="btn-back-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <span class="client-name-header">{{ clientData.client.first_name }} {{ clientData.client.last_name }}</span>
        <button class="btn-edit-header" (click)="openEditClientModal()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
            <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
          </svg>
          Edit
        </button>
      </div>
      <div class="header-spacer"></div>
      <div class="header-chips">
        <div class="info-chip small">
          <span class="chip-icon">üìß</span>
          <span class="chip-value">{{ clientData.client.email }}</span>
        </div>
        <div class="info-chip small">
          <span class="chip-icon">üìû</span>
          <span class="chip-value">{{ clientData.client.phone || 'N/A' }}</span>
        </div>
        <div class="info-chip small">
          <span class="chip-icon">üêæ</span>
          <span class="chip-value">{{ clientData.pets.length }}</span>
        </div>
        <div class="info-chip small highlight">
          <span class="chip-value">{{ formatCurrency(clientData.client.total_spent) }}</span>
        </div>
      </div>
    </div>

    <!-- Top Row: Profile, Stats, Payment Methods (3-column) -->
    <div class="top-row">
      <!-- Profile Card -->
      <div class="compact-card">
        <div class="compact-header">
          <h3>Profile</h3>
        </div>
        <div class="compact-body">
          <div class="profile-row">
            <img
              *ngIf="clientData.client.avatar_url"
              [src]="clientData.client.avatar_url"
              [alt]="clientData.client.first_name + ' ' + clientData.client.last_name"
              class="avatar-img-small"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"
            />
            <div
              *ngIf="!clientData.client.avatar_url"
              class="avatar-small"
            >
              {{ clientData.client.first_name.charAt(0) }}{{ clientData.client.last_name.charAt(0) }}
            </div>
            <div class="profile-details">
              <span class="profile-name">{{ clientData.client.first_name }} {{ clientData.client.last_name }}</span>
              <div class="contact-icons">
                <a [href]="'mailto:' + clientData.client.email" class="contact-link" title="Email">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                    <polyline points="22,6 12,13 2,6"/>
                  </svg>
                </a>
                <a *ngIf="clientData.client.phone" [href]="'tel:' + clientData.client.phone" class="contact-link" title="Call">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/>
                  </svg>
                </a>
                <a *ngIf="clientData.client.phone" [href]="'sms:' + clientData.client.phone" class="contact-link" title="SMS">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                  </svg>
                </a>
              </div>
            </div>
          </div>
          <div class="detail-row">
            <span class="detail-label">Member Since</span>
            <span class="detail-value">{{ formatDate(clientData.client.created_at) }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Last Login</span>
            <span class="detail-value">{{ formatDateTime(clientData.client.last_sign_in_at) }}</span>
          </div>
          <div class="detail-row" *ngIf="clientData.client.blocked_at">
            <span class="detail-label">Status</span>
            <span class="status-blocked">Blocked</span>
          </div>
        </div>
      </div>

      <!-- Stats Card -->
      <div class="compact-card">
        <div class="compact-header">
          <h3>Statistics</h3>
        </div>
        <div class="compact-body">
          <div class="stat-item-compact">
            <span class="stat-label-compact">Total Bookings</span>
            <span class="stat-value-compact">{{ clientData.client.total_bookings }}</span>
          </div>
          <div class="stat-item-compact">
            <span class="stat-label-compact">Total Spent</span>
            <span class="stat-value-compact">{{ formatCurrency(clientData.client.total_spent) }}</span>
          </div>
          <div class="stat-item-compact">
            <span class="stat-label-compact">Last Booking</span>
            <span class="stat-value-compact">{{ clientData.client.last_booking_date ? formatDate(clientData.client.last_booking_date) : 'Never' }}</span>
          </div>
        </div>
      </div>

      <!-- Payment Methods Section (moved to top row) -->
      <div class="compact-card">
        <div class="compact-header">
          <h3>Payment ({{ clientData.paymentMethods.length }})</h3>
          <button class="btn-add-compact" (click)="openPaymentMethodModal()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14M5 12h14" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Add
          </button>
        </div>
        <div *ngIf="clientData.paymentMethods.length === 0" class="empty-state">
          No cards
        </div>
        <div class="payment-methods-list-compact" *ngIf="clientData.paymentMethods.length > 0">
          <div class="payment-item-compact" *ngFor="let pm of clientData.paymentMethods">
            <div class="payment-header-compact">
              <span class="card-brand-compact">{{ pm.brand | uppercase }}</span>
              <span class="badge-default" *ngIf="pm.is_default">Default</span>
            </div>
            <div class="payment-details-compact">
              <div class="card-number-compact">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {{ pm.last4 }}</div>
              <div class="card-expiry-compact">Exp: {{ pm.exp_month }}/{{ pm.exp_year }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Middle Row: Pets & Addresses (2-column) -->
    <div class="middle-row">
      <!-- Pets Section -->
      <div class="compact-card">
        <div class="compact-header">
          <h3>Pets ({{ clientData.pets.length }})</h3>
          <button class="btn-add-compact" (click)="openAddPetModal()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14M5 12h14" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Add Pet
          </button>
        </div>
        <div *ngIf="clientData.pets.length === 0" class="empty-state">
          No pets registered
        </div>
        <div class="pets-grid-compact" *ngIf="clientData.pets.length > 0">
          <div class="pet-card-compact" *ngFor="let pet of clientData.pets" (click)="openEditPetModal(pet)">
            <div class="pet-top">
              <img
                *ngIf="pet.photo_url"
                [src]="getPetPhotoUrl(pet.photo_url)"
                [alt]="pet.name"
                class="pet-photo-small"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"
              />
              <div *ngIf="!pet.photo_url" class="pet-placeholder">
                üêæ
              </div>
              <div class="pet-info-compact">
                <span class="pet-name">{{ pet.name }}</span>
                <span class="pet-breed">{{ pet.breed || 'Unknown breed' }}</span>
                <div class="pet-badges-compact">
                  <span class="badge-small" *ngIf="pet.size_category">{{ pet.size_category }}</span>
                </div>
              </div>
            </div>
            <button
              class="expand-btn"
              [class.expanded]="expandedPets[pet.id]"
              (click)="togglePetDetails(pet.id); $event.stopPropagation()"
            >
              <span>{{ expandedPets[pet.id] ? 'Hide' : 'Show' }} Health Details</span>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9l6 6 6-6" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div class="pet-health-collapsed" [class.expanded]="expandedPets[pet.id]">
              <div class="health-grid-compact">
                <div class="health-item-compact" *ngIf="pet.age || pet.date_of_birth">
                  <span class="hl">Age:</span>
                  <span class="hv">{{ pet.age || calculateAge(pet.date_of_birth) }}</span>
                </div>
                <div class="health-item-compact">
                  <span class="hl">Allergies:</span>
                  <span class="hv" [class.negative]="pet.has_allergies">{{ pet.has_allergies ? 'Yes' : 'No' }}</span>
                </div>
                <div class="health-item-compact">
                  <span class="hl">Skin Cond.:</span>
                  <span class="hv" [class.negative]="pet.has_skin_conditions">{{ pet.has_skin_conditions ? 'Yes' : 'No' }}</span>
                </div>
                <div class="health-item-compact" *ngIf="pet.blow_dryer_reaction">
                  <span class="hl">Dryer:</span>
                  <span class="hv">{{ pet.blow_dryer_reaction }}</span>
                </div>
                <div class="health-item-compact" *ngIf="pet.water_reaction">
                  <span class="hl">Water:</span>
                  <span class="hv">{{ pet.water_reaction }}</span>
                </div>
              </div>
              <div class="health-notes" *ngIf="pet.has_allergies && pet.allergy_details">
                <strong>Allergies:</strong> {{ pet.allergy_details }}
              </div>
              <div class="health-notes" *ngIf="pet.has_skin_conditions && pet.skin_condition_details">
                <strong>Skin:</strong> {{ pet.skin_condition_details }}
              </div>
              <div class="health-notes" *ngIf="pet.special_notes || pet.additional_notes">
                <strong>Notes:</strong> {{ pet.special_notes || pet.additional_notes }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Addresses Section -->
      <div class="compact-card">
        <div class="compact-header">
          <h3>Addresses ({{ clientData.addresses.length }})</h3>
          <button class="btn-add-compact" (click)="openAddAddressModal()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14M5 12h14" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Add Address
          </button>
        </div>
        <div *ngIf="clientData.addresses.length === 0" class="empty-state">
          No addresses saved
        </div>
        <div class="addresses-list-compact" *ngIf="clientData.addresses.length > 0">
          <div class="address-item-compact" *ngFor="let address of clientData.addresses">
            <div class="address-header-compact">
              <span class="address-name-compact">{{ address.name }}</span>
              <div class="address-badges-compact">
                <span class="badge-default" *ngIf="address.is_default">Default</span>
                <span class="badge-type">{{ address.address_type }}</span>
              </div>
            </div>
            <div class="address-details-compact">
              <span *ngIf="address.building && address.street">{{ address.building }}<br/></span>
              {{ address.street || address.building }}<span *ngIf="address.apartment">, Apt {{ address.apartment }}</span><span *ngIf="address.floor">, Floor {{ address.floor }}</span><br/>
              {{ address.city }}, {{ address.state }} {{ address.zip_code }}
              <div *ngIf="address.additional_info">{{ address.additional_info }}</div>
            </div>
            <div class="address-actions-compact">
              <button class="btn-icon-compact" (click)="openEditAddressModal(address)" title="Edit">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
              </button>
              <button class="btn-icon-compact danger" (click)="deleteAddress(address)" title="Delete">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Booking History Section (full-width) -->
    <div class="compact-card">
      <div class="compact-header">
        <h3>Booking History ({{ clientData.bookings.length }})</h3>
      </div>
      <div *ngIf="clientData.bookings.length === 0" class="empty-state">
        No bookings yet
      </div>
      <!-- Desktop Table View -->
      <div class="bookings-table-compact desktop-view" *ngIf="clientData.bookings.length > 0">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Time</th>
              <th>Service</th>
              <th>Groomer</th>
              <th>Amount</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let booking of clientData.bookings" (click)="viewBooking(booking.id)" style="cursor: pointer;">
              <td>{{ formatDate(booking.scheduled_date) }}</td>
              <td>{{ formatTime(booking.scheduled_time_start) }} - {{ formatTime(booking.scheduled_time_end) }}</td>
              <td>{{ booking.service_name || 'N/A' }}</td>
              <td>{{ booking.groomer_name || 'Unassigned' }}</td>
              <td>{{ formatCurrency(booking.total_amount) }}</td>
              <td>
                <span [class]="'status-badge-small ' + getStatusClass(booking.status)">
                  {{ getStatusLabel(booking.status) }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- Mobile Card View -->
      <div class="mobile-view" *ngIf="clientData.bookings.length > 0">
        <div class="booking-card-mobile" *ngFor="let booking of clientData.bookings" (click)="viewBooking(booking.id)">
          <div class="booking-card-header">
            <div class="booking-date">{{ formatDate(booking.scheduled_date) }}</div>
            <span [class]="'status-badge-small ' + getStatusClass(booking.status)">
              {{ getStatusLabel(booking.status) }}
            </span>
          </div>
          <div class="booking-card-details">
            <div class="booking-detail-row">
              <span class="detail-label">Time:</span>
              <span class="detail-value">{{ formatTime(booking.scheduled_time_start) }} - {{ formatTime(booking.scheduled_time_end) }}</span>
            </div>
            <div class="booking-detail-row">
              <span class="detail-label">Service:</span>
              <span class="detail-value">{{ booking.service_name || 'N/A' }}</span>
            </div>
            <div class="booking-detail-row">
              <span class="detail-label">Groomer:</span>
              <span class="detail-value">{{ booking.groomer_name || 'Unassigned' }}</span>
            </div>
            <div class="booking-detail-row">
              <span class="detail-label">Amount:</span>
              <span class="detail-value amount">{{ formatCurrency(booking.total_amount) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin Notes Section (full-width) -->
    <div class="compact-card">
      <div class="compact-header">
        <h3>Admin Notes</h3>
      </div>
      <div class="compact-body">
        <!-- Add Note Form -->
        <div class="add-note-form-compact">
          <div class="form-row-compact">
            <label for="note-priority">Priority:</label>
            <select id="note-priority" [(ngModel)]="newNotePriority" class="form-select-compact">
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
          <div class="form-row-compact">
            <label for="note-text">Note:</label>
            <textarea
              id="note-text"
              [(ngModel)]="newNoteText"
              class="form-textarea-compact"
              rows="3"
              placeholder="Enter admin note..."
            ></textarea>
          </div>
          <button
            (click)="addAdminNote()"
            [disabled]="!newNoteText.trim() || addingNote"
            class="btn-add-compact"
          >
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14M5 12h14" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            {{ addingNote ? 'Adding...' : 'Add Note' }}
          </button>
        </div>

        <!-- Notes List -->
        <div *ngIf="clientData.adminNotes.length === 0" class="empty-state">
          No admin notes yet
        </div>
        <div class="notes-list-compact" *ngIf="clientData.adminNotes.length > 0">
          <div class="note-item-compact" *ngFor="let note of clientData.adminNotes">
            <div class="note-header-compact">
              <div class="note-meta-compact">
                <span [class]="'priority-badge-compact priority-' + (note.priority || 'medium')">{{ note.priority || 'medium' }}</span>
                <span class="note-author-compact">{{ note.admin?.first_name }} {{ note.admin?.last_name }}</span>
              </div>
              <span class="note-date-compact">{{ formatDate(note.created_at) }}</span>
            </div>
            <p class="note-content-compact">{{ note.note }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Pet Modal -->
    <app-add-pet-modal
      *ngIf="showAddPetModal"
      [clientId]="clientData.client.id"
      (close)="closePetModal()"
      (petAdded)="onPetAdded()"
    ></app-add-pet-modal>

    <!-- Edit Pet Modal -->
    <app-add-pet-modal
      *ngIf="showEditPetModal && selectedPet"
      [clientId]="clientData.client.id"
      [pet]="selectedPet"
      (close)="closePetModal()"
      (petUpdated)="onPetUpdated()"
    ></app-add-pet-modal>

    <!-- Edit Client Modal -->
    <app-edit-client-modal
      *ngIf="showEditClientModal"
      [client]="clientData.client"
      (close)="closeEditClientModal()"
      (clientUpdated)="onClientUpdated()"
    ></app-edit-client-modal>

    <!-- Add Address Modal -->
    <app-mapbox-address-modal
      *ngIf="showAddAddressModal"
      [clientId]="clientData.client.id"
      (close)="closeAddressModal()"
      (addressSaved)="onAddressSaved()"
    ></app-mapbox-address-modal>

    <!-- Edit Address Modal -->
    <app-mapbox-address-modal
      *ngIf="showEditAddressModal && selectedAddress"
      [clientId]="clientData.client.id"
      [address]="selectedAddress"
      (close)="closeAddressModal()"
      (addressSaved)="onAddressSaved()"
    ></app-mapbox-address-modal>

    <!-- Payment Method Modal -->
    <app-payment-method-modal
      *ngIf="showPaymentMethodModal"
      [clientId]="clientData.client.id"
      (close)="closePaymentMethodModal()"
      (paymentMethodAdded)="onPaymentMethodAdded()"
    ></app-payment-method-modal>
  </div>
</div>

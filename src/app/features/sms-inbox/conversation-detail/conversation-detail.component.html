<div class="conversation-detail">
  <!-- Header -->
  <div class="detail-header">
    <button class="back-button" (click)="goBack()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m15 18-6-6 6-6"/>
      </svg>
      Back
    </button>

    <div class="header-info" *ngIf="conversation">
      <h2>{{ conversation.user_name || 'Unknown' }}</h2>
      <div class="header-meta">
        <span class="phone">{{ conversation.phone_number }}</span>
        <span class="status badge" [ngClass]="getStatusClass(conversation.status)">
          {{ getStatusLabel(conversation.status) }}
        </span>
      </div>
    </div>

    <div class="header-actions" *ngIf="conversation">
      <button
        class="action-btn resolve"
        *ngIf="conversation.status !== 'resolved'"
        (click)="resolveConversation()"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
        Resolve
      </button>
      <button
        class="action-btn escalate"
        *ngIf="conversation.status === 'active'"
        (click)="escalateConversation()"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        Escalate
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Loading conversation...</p>
  </div>

  <!-- Error State -->
  <div class="error-state" *ngIf="error && !isLoading">
    <p>{{ error }}</p>
    <button (click)="loadConversation()">Try Again</button>
  </div>

  <!-- Messages -->
  <div class="messages-container" #messagesContainer *ngIf="!isLoading && !error">
    <div class="messages-list">
      <ng-container *ngFor="let message of messages; let i = index">
        <!-- Date Divider -->
        <div class="date-divider" *ngIf="shouldShowDateDivider(message, i)">
          <span>{{ formatDate(message.created_at) }}</span>
        </div>

        <!-- Message Bubble -->
        <div class="message" [ngClass]="getMessageClass(message)">
          <div class="message-bubble">
            <div class="message-content">{{ message.content }}</div>

            <!-- Media Attachments -->
            <div class="message-media" *ngIf="message.media_urls && message.media_urls.length > 0">
              <img
                *ngFor="let url of message.media_urls"
                [src]="url"
                alt="Attachment"
                class="media-image"
              />
            </div>

            <div class="message-meta">
              <span class="message-type" *ngIf="getMessageTypeLabel(message)">
                {{ getMessageTypeLabel(message) }}
              </span>
              <span class="message-time">{{ formatTime(message.created_at) }}</span>
              <span class="message-status" *ngIf="message.direction === 'outbound'">
                <svg *ngIf="message.status === 'delivered'" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="20 6 9 17 4 12"/>
                  <polyline points="20 6 9 17 4 12" transform="translate(5, 0)"/>
                </svg>
                <svg *ngIf="message.status === 'sent'" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                <svg *ngIf="message.status === 'failed'" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="15" y1="9" x2="9" y2="15"/>
                  <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
              </span>
            </div>
          </div>

          <!-- AI Intent Badge -->
          <div class="ai-info" *ngIf="message.ai_intent && message.direction === 'inbound'">
            <span class="intent-badge">
              {{ getIntentLabel(message.ai_intent) }}
            </span>
            <span class="confidence" *ngIf="message.ai_confidence">
              {{ (message.ai_confidence * 100).toFixed(0) }}% confidence
            </span>
          </div>
        </div>
      </ng-container>
    </div>
  </div>

  <!-- Compose Area -->
  <div class="compose-area" *ngIf="!isLoading && !error && conversation?.status !== 'resolved'">
    <div class="compose-input-wrapper">
      <textarea
        class="compose-input"
        [(ngModel)]="newMessage"
        placeholder="Type a message..."
        rows="1"
        (keydown)="onKeydown($event)"
        [disabled]="isSending"
      ></textarea>
      <button
        class="send-button"
        (click)="sendMessage()"
        [disabled]="!newMessage.trim() || isSending"
      >
        <svg *ngIf="!isSending" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"/>
          <polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
        <div class="spinner-small" *ngIf="isSending"></div>
      </button>
    </div>
  </div>

  <!-- Resolved Notice -->
  <div class="resolved-notice" *ngIf="conversation?.status === 'resolved'">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="20 6 9 17 4 12"/>
    </svg>
    This conversation has been resolved
  </div>
</div>

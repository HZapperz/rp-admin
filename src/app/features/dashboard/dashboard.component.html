<div class="dashboard">
  @if (isLoading) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading dashboard data...</p>
    </div>
  }

  @if (error) {
    <div class="error-message">
      {{ error }}
    </div>
  }

  @if (!isLoading && !error) {
    <!-- KPI Period Toggle -->
    <div class="kpi-header">
      <h2>Overview</h2>
      <div class="kpi-period-toggle">
        <button
          class="period-btn"
          [class.active]="kpiPeriod === 'week'"
          (click)="toggleKPIPeriod('week')">
          This Week
        </button>
        <button
          class="period-btn"
          [class.active]="kpiPeriod === 'month'"
          (click)="toggleKPIPeriod('month')">
          This Month
        </button>
      </div>
    </div>

    <!-- Stats Overview -->
    <div class="stats-overview">
      <!-- Appointments Card -->
      <div class="stat-card appointments">
        <div class="stat-header">
          <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
          </div>
          <div class="stat-title">Appointments</div>
        </div>
        <div class="stat-values">
          <div class="stat-value-group">
            <div class="stat-number">{{ kpiCards.bookings.completed }}</div>
            <div class="stat-label">Completed</div>
          </div>
          <div class="stat-divider"></div>
          <div class="stat-value-group pending-value">
            <div class="stat-number">{{ kpiCards.bookings.pending }}</div>
            <div class="stat-label">Upcoming</div>
          </div>
        </div>
        <div class="stat-period">{{ getKPIPeriodLabel() }}</div>
      </div>

      <!-- Pets Card -->
      <div class="stat-card pets">
        <div class="stat-header">
          <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-linecap="round" stroke-linejoin="round">
              <ellipse cx="8" cy="8" rx="2.5" ry="3"/>
              <ellipse cx="16" cy="8" rx="2.5" ry="3"/>
              <ellipse cx="5" cy="14" rx="2" ry="2.5"/>
              <ellipse cx="19" cy="14" rx="2" ry="2.5"/>
              <path d="M12 11c-3 0-5.5 2.5-5.5 5.5 0 2 1.5 3.5 3 4s3 .5 5 0 3-2 3-4c0-3-2.5-5.5-5.5-5.5z"/>
            </svg>
          </div>
          <div class="stat-title">Pets</div>
        </div>
        <div class="stat-values">
          <div class="stat-value-group">
            <div class="stat-number">{{ kpiCards.pets.completed }}</div>
            <div class="stat-label">Groomed</div>
          </div>
          <div class="stat-divider"></div>
          <div class="stat-value-group pending-value">
            <div class="stat-number">{{ kpiCards.pets.pending }}</div>
            <div class="stat-label">Scheduled</div>
          </div>
        </div>
        <div class="stat-period">{{ getKPIPeriodLabel() }}</div>
      </div>

      <!-- Revenue Card -->
      <div class="stat-card revenue">
        <div class="stat-header">
          <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
          </div>
          <div class="stat-title">Revenue</div>
        </div>
        <div class="stat-values">
          <div class="stat-value-group">
            <div class="stat-number">${{ kpiCards.revenue.collected | number:'1.0-0' }}</div>
            <div class="stat-label">Collected</div>
          </div>
          <div class="stat-divider"></div>
          <div class="stat-value-group pending-value">
            <div class="stat-number">${{ kpiCards.revenue.pending | number:'1.0-0' }}</div>
            <div class="stat-label">Pending</div>
          </div>
        </div>
        <div class="stat-period">{{ getKPIPeriodLabel() }}</div>
      </div>
    </div>

    <!-- Period Navigation Controls -->
    <div class="period-navigation">
      <button class="nav-btn" (click)="previousPeriod()" title="Previous {{ kpiPeriod }}">←</button>
      <button class="today-btn" (click)="goToToday()">Today</button>
      <button class="nav-btn" (click)="nextPeriod()" title="Next {{ kpiPeriod }}">→</button>
    </div>

    <!-- Schedule Section -->
    <div class="schedule-section">
      <div class="schedule-header">
        <h2>Schedule</h2>
        <div class="period-label">{{ getPeriodLabel() }}</div>
      </div>

      <!-- Day View -->
      @if (currentView === 'day') {
        <div class="time-grid-view">
          <!-- Time Labels Column -->
          <div class="time-labels">
            <div class="time-label-header"></div>
            @for (time of timeSlots; track time) {
              <div class="time-label">{{ time }}</div>
            }
          </div>

          <!-- Day Column -->
          @for (slot of scheduleSlots; track slot.date) {
            <div class="time-grid-column" [class.today]="slot.isToday">
              <div class="time-grid-header" [class.today]="slot.isToday">
                <div class="day-name">{{ slot.date | date:'EEEE' }}</div>
                <div class="day-date">{{ slot.date | date:'MMM d' }}</div>
              </div>
              <div class="time-grid-body">
                <!-- Hour lines -->
                @for (time of timeSlots; track time) {
                  <div class="hour-line"></div>
                }
                <!-- Bookings -->
                @for (booking of slot.bookings; track booking.id) {
                  <div
                    class="time-grid-booking clickable"
                    [ngClass]="getStatusClass(booking.status)"
                    [style.top.%]="getBookingTop(booking.scheduled_time_start)"
                    [style.height.%]="getBookingHeight(booking.scheduled_time_start, booking.scheduled_time_end)"
                    (click)="openBookingDetail(booking)">
                    <div class="tgb-time">{{ formatTime(booking.scheduled_time_start) }}</div>
                    <div class="tgb-client">{{ booking.client?.first_name }} {{ booking.client?.last_name }}</div>
                    <div class="tgb-service">{{ booking.service_name }}</div>
                    <div class="tgb-duration">{{ getBookingDuration(booking.scheduled_time_start, booking.scheduled_time_end) }}</div>
                    @if (booking.groomer) {
                      <div class="tgb-groomer">{{ booking.groomer.first_name }}</div>
                    }
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }

      <!-- Week View -->
      @if (currentView === 'week') {
        <div class="time-grid-view week">
          <!-- Time Labels Column -->
          <div class="time-labels">
            <div class="time-label-header"></div>
            @for (time of timeSlots; track time) {
              <div class="time-label">{{ time }}</div>
            }
          </div>

          <!-- Day Columns -->
          @for (slot of scheduleSlots; track slot.date) {
            <div class="time-grid-column" [class.today]="slot.isToday">
              <div class="time-grid-header" [class.today]="slot.isToday">
                <div class="day-name">{{ slot.date | date:'EEE' }}</div>
                <div class="day-date">{{ slot.date | date:'d' }}</div>
              </div>
              <div class="time-grid-body">
                <!-- Hour lines -->
                @for (time of timeSlots; track time) {
                  <div class="hour-line"></div>
                }
                <!-- Bookings -->
                @for (booking of slot.bookings; track booking.id) {
                  <div
                    class="time-grid-booking compact clickable"
                    [ngClass]="getStatusClass(booking.status)"
                    [style.top.%]="getBookingTop(booking.scheduled_time_start)"
                    [style.height.%]="getBookingHeight(booking.scheduled_time_start, booking.scheduled_time_end)"
                    [title]="booking.client?.first_name + ' ' + booking.client?.last_name + ' - ' + booking.service_name + ' (' + getBookingDuration(booking.scheduled_time_start, booking.scheduled_time_end) + ')'"
                    (click)="openBookingDetail(booking)">
                    <div class="tgb-time">{{ formatTime(booking.scheduled_time_start) }}</div>
                    <div class="tgb-client">{{ booking.client?.first_name }}</div>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }

      <!-- Month View -->
      @if (currentView === 'month') {
        <div class="month-view">
          <div class="month-header">
            <div class="month-day-name">Sun</div>
            <div class="month-day-name">Mon</div>
            <div class="month-day-name">Tue</div>
            <div class="month-day-name">Wed</div>
            <div class="month-day-name">Thu</div>
            <div class="month-day-name">Fri</div>
            <div class="month-day-name">Sat</div>
          </div>
          <div class="month-grid">
            @for (slot of scheduleSlots; track slot.date) {
              <div class="month-day-cell"
                   [class.today]="slot.isToday"
                   [class.other-month]="!slot.isCurrentMonth">
                <div class="day-number">{{ slot.date | date:'d' }}</div>
                @if (slot.bookings.length > 0) {
                  <div class="bookings-count">{{ slot.bookings.length }} booking{{ slot.bookings.length > 1 ? 's' : '' }}</div>
                  <div class="booking-dots">
                    @for (booking of slot.bookings.slice(0, 3); track booking.id) {
                      <div class="booking-dot" [ngClass]="getStatusClass(booking.status)"></div>
                    }
                    @if (slot.bookings.length > 3) {
                      <div class="more-bookings">+{{ slot.bookings.length - 3 }}</div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }
    </div>
  }
</div>

<!-- Business Settings Modal -->
@if (showBusinessSettingsModal) {
  <app-business-settings-modal
    (close)="closeBusinessSettings()"
    (settingsSaved)="onBusinessSettingsSaved()">
  </app-business-settings-modal>
}

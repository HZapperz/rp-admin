@if (booking) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <!-- Header -->
      <div class="modal-header">
        <div class="header-left">
          <h2>Booking Details</h2>
          <span class="booking-id">ID: {{ booking.id.substring(0, 8) }}...</span>
        </div>
        <button class="close-btn" (click)="closeModal()" title="Close">‚úï</button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <!-- Booking Status & Summary -->
        <div class="section status-section">
          <div class="status-header">
            <span class="status-badge" [ngClass]="getStatusClass(booking.status)">
              {{ getStatusLabel(booking.status) }}
            </span>
            <span class="booking-date">{{ formatDate(booking.scheduled_date) }}</span>
          </div>
          @if (booking.scheduled_time_start && booking.scheduled_time_end) {
            <div class="time-slot">
              <span class="icon">üïê</span>
              <span>{{ booking.scheduled_time_start }} - {{ booking.scheduled_time_end }}</span>
            </div>
          }
        </div>

        <!-- Client Information -->
        <div class="section client-section">
          <h3 class="section-title">Client Information</h3>
          <div class="info-grid">
            <div class="info-item">
              <span class="label">Name:</span>
              <span class="value">{{ booking.client?.first_name }} {{ booking.client?.last_name }}</span>
            </div>
            @if (booking.client?.phone) {
              <div class="info-item">
                <span class="label">Phone:</span>
                <span class="value">{{ booking.client?.phone }}</span>
              </div>
            }
            @if (booking.client?.email) {
              <div class="info-item">
                <span class="label">Email:</span>
                <span class="value">{{ booking.client?.email }}</span>
              </div>
            }
            <div class="info-item full-width">
              <span class="label">Address:</span>
              <span class="value">{{ booking.address }}, {{ booking.city }}, {{ booking.state }} {{ booking.zip_code }}</span>
            </div>
            @if (booking.notes) {
              <div class="info-item full-width">
                <span class="label">Booking Notes:</span>
                <span class="value notes">{{ booking.notes }}</span>
              </div>
            }
          </div>
        </div>

        <!-- Pet Information -->
        <div class="section pets-section">
          <h3 class="section-title">Pet Information</h3>
          @if (booking.pets && booking.pets.length > 0) {
            <div class="pets-grid">
              @for (bookingPet of booking.pets; track bookingPet.id) {
                <div class="pet-card">
                  @if (bookingPet.pet?.photo_url) {
                    <div class="pet-photo">
                      <img [src]="bookingPet.pet?.photo_url" [alt]="bookingPet.pet?.name || 'Pet'" />
                    </div>
                  } @else {
                    <div class="pet-photo placeholder">
                      <span class="icon">üêæ</span>
                    </div>
                  }
                  <div class="pet-info">
                    <h4 class="pet-name">{{ bookingPet.pet?.name }}</h4>
                    <div class="pet-details">
                      @if (bookingPet.pet && bookingPet.pet.breed) {
                        <span class="detail-item">üêï {{ bookingPet.pet.breed }}</span>
                      }
                      @if (bookingPet.pet && bookingPet.pet.age) {
                        <span class="detail-item">üìÖ {{ bookingPet.pet.age }}</span>
                      }
                      @if (bookingPet.service_size) {
                        <span class="detail-item size-badge" [class]="'size-' + bookingPet.service_size">
                          {{ bookingPet.service_size | uppercase }}
                        </span>
                      }
                    </div>
                    @if (bookingPet.pet && bookingPet.pet.special_notes) {
                      <div class="special-notes">
                        <strong>Special Notes:</strong>
                        <p>{{ bookingPet.pet.special_notes }}</p>
                      </div>
                    }
                    @if (bookingPet.package_type) {
                      <div class="package-info">
                        <span class="package-badge">{{ getPackageLabel(bookingPet.package_type) }}</span>
                        <span class="package-price">{{ formatCurrency(bookingPet.package_price || 0) }}</span>
                      </div>
                    }
                    @if (bookingPet.addons && bookingPet.addons.length > 0) {
                      <div class="addons-list">
                        <strong>Add-ons:</strong>
                        <ul>
                          @for (addon of bookingPet.addons; track addon.id) {
                            <li>{{ addon.addon_name }} - {{ formatCurrency(addon.addon_price) }}</li>
                          }
                        </ul>
                      </div>
                    }
                    <!-- Rabies Certificate -->
                    @if (bookingPet.pet && bookingPet.pet.rabies_certificate_url) {
                      <div class="rabies-cert">
                        <button class="cert-btn verified" (click)="viewRabiesCertificate(bookingPet.pet.rabies_certificate_url)">
                          ‚úì View Rabies Certificate
                        </button>
                      </div>
                    } @else {
                      <div class="rabies-cert">
                        <span class="cert-status missing">‚ö†Ô∏è No Rabies Certificate</span>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          } @else {
            <p class="no-data">No pet information available</p>
          }
        </div>

        <!-- Service & Pricing -->
        <div class="section pricing-section">
          <h3 class="section-title">Service & Pricing</h3>
          <div class="pricing-details">
            <div class="price-row">
              <span class="label">Service:</span>
              <span class="value">{{ booking.service_name || 'Grooming Service' }}</span>
            </div>
            @if (booking.service_fee) {
              <div class="price-row">
                <span class="label">Service Fee:</span>
                <span class="value">{{ formatCurrency(booking.service_fee) }}</span>
              </div>
            }
            @if (booking.processing_fee) {
              <div class="price-row">
                <span class="label">Processing Fee:</span>
                <span class="value">{{ formatCurrency(booking.processing_fee) }}</span>
              </div>
            }
            @if (booking.rush_service) {
              <div class="price-row rush">
                <span class="label">üöÄ Rush Service Fee:</span>
                <span class="value">{{ formatCurrency(booking.rush_fee || 0) }}</span>
              </div>
            }
            <div class="price-row total">
              <span class="label">Total Amount:</span>
              <span class="value">{{ formatCurrency(booking.total_amount) }}</span>
            </div>
          </div>
        </div>

        <!-- Payment Information -->
        @if (booking.payment_status || booking.stripe_charge_id) {
          <div class="section payment-section">
            <h3 class="section-title">Payment Information</h3>
            <div class="payment-details">
              @if (booking.payment_status) {
                <div class="payment-row">
                  <span class="label">Payment Status:</span>
                  <span class="payment-status-badge" [ngClass]="getPaymentStatusClass(booking.payment_status)">
                    {{ booking.payment_status | uppercase }}
                  </span>
                </div>
              }
              @if (booking.amount_paid) {
                <div class="payment-row">
                  <span class="label">Amount Paid:</span>
                  <span class="value">{{ formatCurrency(booking.amount_paid) }}</span>
                </div>
              }
              @if (booking.stripe_charge_id) {
                <div class="payment-row">
                  <span class="label">Transaction ID:</span>
                  <span class="value transaction-id">{{ booking.stripe_charge_id }}</span>
                </div>
              }
              @if (booking.payment_intent_id) {
                <div class="payment-row">
                  <span class="label">Payment Intent:</span>
                  <span class="value transaction-id">{{ booking.payment_intent_id }}</span>
                </div>
              }
            </div>
          </div>
        }

        <!-- Groomer Assignment -->
        @if (booking.groomer) {
          <div class="section groomer-section">
            <h3 class="section-title">Assigned Groomer</h3>
            <div class="groomer-info">
              <div class="groomer-avatar">{{ booking.groomer.first_name[0] }}{{ booking.groomer.last_name[0] }}</div>
              <div class="groomer-details">
                <div class="groomer-name">{{ booking.groomer.first_name }} {{ booking.groomer.last_name }}</div>
                @if (booking.groomer && booking.groomer.phone) {
                  <div class="groomer-contact">üìû {{ booking.groomer.phone }}</div>
                }
              </div>
            </div>
          </div>
        }

        <!-- Cancellation Info -->
        @if (booking.status === 'cancelled' && booking.cancellation_reason) {
          <div class="section cancellation-section">
            <h3 class="section-title">Cancellation Information</h3>
            <div class="cancellation-info">
              <p><strong>Reason:</strong> {{ booking.cancellation_reason }}</p>
              @if (booking.cancelled_at) {
                <p><strong>Cancelled At:</strong> {{ formatDate(booking.cancelled_at) }}</p>
              }
            </div>
          </div>
        }
      </div>

      <!-- Footer Actions -->
      <div class="modal-footer">
        @if (booking.status === 'pending') {
          <button class="btn btn-approve" (click)="openApproveModal()">
            ‚úì Approve & Assign Groomer
          </button>
          <button class="btn btn-reject" (click)="openRejectDialog()">
            ‚úó Reject Booking
          </button>
        }
        <button class="btn btn-secondary" (click)="closeModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Groomer Assignment Modal (nested) -->
  @if (showGroomerModal) {
    <div class="modal-overlay nested" (click)="closeGroomerModal()">
      <div class="modal-container small" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Assign Groomer & Time Slot</h2>
          <button class="close-btn" (click)="closeGroomerModal()">‚úï</button>
        </div>
        <div class="modal-body">
          <!-- Time Slot Selection -->
          <div class="form-section">
            <label class="form-label">Select Time Slot</label>
            <select class="form-select" [(ngModel)]="selectedTimeSlot">
              <option [ngValue]="null">-- Select a time slot --</option>
              <optgroup label="Morning">
                <option *ngFor="let slot of morningSlots" [ngValue]="slot">
                  {{ slot.label }}
                </option>
              </optgroup>
              <optgroup label="Afternoon">
                <option *ngFor="let slot of afternoonSlots" [ngValue]="slot">
                  {{ slot.label }}
                </option>
              </optgroup>
            </select>
          </div>

          <!-- Groomer Selection -->
          <div class="form-section">
            <label class="form-label">Select Groomer</label>
            <div class="groomer-grid">
              @for (groomer of availableGroomers; track groomer.id) {
                <div
                  class="groomer-card"
                  [class.selected]="selectedGroomerId === groomer.id"
                  (click)="selectedGroomerId = groomer.id">
                  <div class="groomer-avatar">{{ groomer.first_name?.[0] }}{{ groomer.last_name?.[0] }}</div>
                  <div class="groomer-info">
                    <div class="groomer-name">{{ groomer.first_name }} {{ groomer.last_name }}</div>
                  </div>
                  @if (selectedGroomerId === groomer.id) {
                    <div class="check-icon">‚úì</div>
                  }
                </div>
              }
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeGroomerModal()">Cancel</button>
          <button
            class="btn btn-primary"
            (click)="assignGroomerAndApprove()"
            [disabled]="!selectedGroomerId || !selectedTimeSlot">
            Approve & Assign
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Rejection Dialog -->
  @if (showRejectDialog) {
    <div class="modal-overlay nested" (click)="closeRejectDialog()">
      <div class="modal-container small" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Reject Booking</h2>
          <button class="close-btn" (click)="closeRejectDialog()">‚úï</button>
        </div>
        <div class="modal-body">
          <div class="form-section">
            <label class="form-label">Reason for Rejection</label>
            <textarea
              class="form-textarea"
              [(ngModel)]="rejectionReason"
              placeholder="Please provide a reason for rejecting this booking..."
              rows="4"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeRejectDialog()">Cancel</button>
          <button class="btn btn-reject" (click)="confirmReject()">Confirm Rejection</button>
        </div>
      </div>
    </div>
  }
}
